<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입 - game forge</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="signup-container">
        <h2>회원가입</h2>
        <form id="signup-form" onsubmit="return handleSignup(event)">
            <div class="form-group">
                <label for="email">아이디 (이메일)</label>
                <input type="email" id="email" required>
                <button type="button" onclick="checkEmail()">중복 확인 및 이메일 인증</button>
                <p id="email-status"></p>
            </div>

            <!-- 이 부분은 처음엔 숨겨져 있다가, 이메일 인증 버튼을 눌렀을 때 보여지는 화면 -->
            <div class="form-group" id="email-verification-group" style="display: none;">
                <label for="verification-code">이메일로 발송된 인증번호</label>
                <input type="text" id="verification-code" required>
                <button type="button" onclick="verifyCode()">인증하기</button>
                <p id="verification-status"></p>
            </div>

            <div class="form-group">
                <label for="password">비밀번호</label>
                <input type="password" id="password" required>
            </div>

            <div class="form-group">
                <label for="confirm-password">비밀번호 확인</label>
                <input type="password" id="confirm-password" required>
                <p id="password-status"></p>
            </div>

            <div class="form-group">
                <label for="name">이름</label>
                <input type="text" id="name" required>
            </div>

            <div class="form-group">
                <label for="gender">성별</label>
                <select id="gender" required>
                    <option value="남">남</option>
                    <option value="여">여</option>
                </select>
            </div>

            <div class="form-group">
                <label for="birthdate">생년월일</label>
                <input type="date" id="birthdate" required>
            </div>

            <button type="submit">회원가입</button>
        </form>
    </div>

    <script>
        let verificationCode = ''; // 서버에서 받은 인증번호
        let timer; // 타이머
        let isEmailVerified = false; // 이메일 인증 여부

        // 이메일 중복 확인 및 인증번호 요청
        function checkEmail() {
            const email = document.getElementById('email').value;
            const emailStatus = document.getElementById('email-status');

            emailStatus.innerText = '이메일 중복 확인 중...';

            // HTTP로 API 요청을 보내도록 URL 수정
            fetch('http://43.203.198.147:8080/api/user/auth/email-authentication', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email: email }) // 서버에 이메일 정보 전송
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    verificationCode = data.verificationCode; // 서버에서 받은 인증번호 저장
                    emailStatus.innerText = '이메일로 인증번호를 전송했습니다. 인증번호를 입력하세요.';
                    emailStatus.style.color = 'green';

                    // 이메일 인증번호 입력란 보여주기
                    document.getElementById('email-verification-group').style.display = 'block';

                    startTimer(3 * 60);  // 3분 타이머 시작
                } else {
                    emailStatus.innerText = '이메일 전송에 실패했습니다.';
                    emailStatus.style.color = 'red';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                emailStatus.innerText = `이메일 전송 중 오류가 발생했습니다. 오류 메시지: ${error.message}`;
                emailStatus.style.color = 'red';
            });
        }

        // 인증번호 확인
        function verifyCode() {
            const inputCode = document.getElementById('verification-code').value;
            const email = document.getElementById('email').value;
            const verificationStatus = document.getElementById('verification-status');

            // HTTP로 API 요청을 보내도록 URL 수정
            fetch('http://43.203.198.147:8080/api/user/auth/check-authentication', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email: email, authenticationCode: inputCode }) // 이메일과 인증번호 전송
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    clearTimeout(timer);
                    isEmailVerified = true;
                    verificationStatus.innerText = '인증 완료되었습니다.';
                    verificationStatus.style.color = 'green';
                } else {
                    verificationStatus.innerText = '잘못된 인증번호입니다.';
                    verificationStatus.style.color = 'red';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                verificationStatus.innerText = `인증 중 오류가 발생했습니다. 오류 메시지: ${error.message}`;
                verificationStatus.style.color = 'red';
            });
        }

        // 비밀번호 확인
        document.getElementById('confirm-password').addEventListener('input', function () {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const passwordStatus = document.getElementById('password-status');

            if (password !== confirmPassword) {
                passwordStatus.innerText = '비밀번호가 일치하지 않습니다.';
                passwordStatus.style.color = 'red';
            } else {
                passwordStatus.innerText = '';
            }
        });

        // 회원가입 처리
        function handleSignup(event) {
            event.preventDefault();

            if (!isEmailVerified) {
                alert('이메일 인증을 완료해주세요.');
                return false;
            }

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const name = document.getElementById('name').value;
            const gender = document.getElementById('gender').value;
            const birthdate = document.getElementById('birthdate').value;

            if (password !== confirmPassword) {
                alert('비밀번호가 일치하지 않습니다.');
                return false;
            }

            // HTTP로 API 요청을 보내도록 URL 수정
            fetch('http://43.203.198.147:8080/api/user/auth/join', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: email,
                    password: password,
                    name: name,
                    gender: gender,
                    birthdate: birthdate
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('회원가입이 완료되었습니다.');
                } else {
                    alert('회원가입에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`회원가입 중 오류가 발생했습니다. 오류 메시지: ${error.message}`);
            });

            return true;
        }

        // 타이머 3분 설정
        function startTimer(duration) {
            const verificationStatus = document.getElementById('verification-status');
            let timeRemaining = duration;

            timer = setInterval(function () {
                timeRemaining--;

                if (timeRemaining <= 0) {
                    clearInterval(timer);
                    verificationStatus.innerText = '인증 시간이 만료되었습니다. 다시 인증해주세요.';
                    verificationStatus.style.color = 'red';
                    isEmailVerified = false;
                }
            }, 1000);
        }
    </script>
</body>
</html>
