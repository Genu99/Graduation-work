async function createOrderAndRequestPay() {
    try {
        const cartItems = JSON.parse(localStorage.getItem('cart'));
        if (!cartItems || cartItems.length === 0) {
            alert('결제할 항목이 없습니다.');
            return;
        }
        const originalAmount = cartItems.reduce((acc, item) => acc + item.price, 0);
        const email = document.getElementById('email').value;
        const rewardPointsUsage = parseFloat(document.getElementById('reward-points-usage').value) || 0;
        const availableRewardPoints = parseFloat(document.getElementById('available-reward-points').textContent) || 0;

        if (rewardPointsUsage > availableRewardPoints) {
            alert('사용하려는 적립금이 보유한 적립금을 초과합니다.');
            return;
        }

        const maxUsablePoints = Math.min(originalAmount * 0.3, availableRewardPoints);
        if (rewardPointsUsage > maxUsablePoints) {
            alert('사용할 적립금은 총 결제 금액의 30%를 초과할 수 없습니다.');
            return;
        }

        const totalAmount = originalAmount - rewardPointsUsage;

        const response = await fetch('https://ludorium.store/api/user/order/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({
                cartIdList: cartItems.map(item => item.id),
                gamePriceList: cartItems.map(item => item.price),
                originalAmount,
                totalAmount,
                rewardPoints: rewardPointsUsage,
                email
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            console.error('주문 생성 실패:', errorData);
            if (errorData.code === 'ORDERING_REWARD_POINTS_FAIL') {
                alert('적립금을 확인해주세요. 사용 가능한 적립금을 초과하거나 잘못된 값입니다.');
            } else {
                alert('주문 생성에 실패했습니다. 입력 정보를 다시 확인해주세요.');
            }
            return;
        }

        const result = await response.json();
        const newMerchantUid = result.data;  // 주문 번호
        localStorage.setItem('newMerchantUid', newMerchantUid);  // 주문 번호 저장

        if (newMerchantUid) {
            const { IMP } = window;
            IMP.init('imp25057626'); // Iamport 식별 코드

            IMP.request_pay(
                {
                    pg: 'html5_inicis',
                    pay_method: 'card',
                    merchant_uid: newMerchantUid,
                    name: '게임 결제',
                    amount: totalAmount,
                    buyer_email: email,
                    buyer_name: document.getElementById('name').value,
                    buyer_tel: '01042424242',
                },
                async (rsp) => {
                    if (rsp.success) {
                        const validateResponse = await fetch(`https://ludorium.store/api/user/payment/validate/${rsp.imp_uid}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            }
                        });

                        if (!validateResponse.ok) {
                            const validateError = await validateResponse.json();
                            console.error('결제 검증 실패:', validateError);
                            alert('결제 검증에 실패했습니다. 주문이 취소되었습니다.');
                            return;
                        }

                        // 결제 검증이 성공했으므로, 주문 상태는 자동으로 업데이트됨
                        alert('결제가 성공적으로 완료되었습니다.');
                        localStorage.removeItem('cart');
                        window.location.href = 'order.html';
                    } else {
                        alert('결제가 취소되었습니다.');
                    }
                }
            );
        }
    } catch (error) {
        console.error('주문 생성 실패:', error);
        alert('주문 생성에 실패했습니다. 네트워크 상태를 확인해주세요.');
    }
}
