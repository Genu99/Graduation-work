<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê²Œì‹œê¸€ ë³´ê¸°</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="boardDetail.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>
<body>
    <!-- í—¤ë”ë¥¼ ë³„ë„ì˜ íŒŒì¼ë¡œ ê°€ì ¸ì˜´ -->
    <div id="header"></div>
    <script>
        // header.html íŒŒì¼ì„ ë¡œë“œí•˜ì—¬ í—¤ë”ë¥¼ ì¶”ê°€
        fetch("header.html")
            .then(response => response.text())
            .then(data => {
                document.getElementById("header").innerHTML = data;
                checkLoginStatus();
            })
            .catch(error => console.error("í—¤ë” ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error));
    </script>
    <script src="auth.js"></script>
    <div class="container">
        <div class="post-title" id="postTitle"></div>

        <!-- ê²Œì‹œê¸€ ì •ë³´ ì˜ì—­: ì‘ì„±ì, ë‚ ì§œ, ì¡°íšŒìˆ˜ -->
        <div class="post-info">
            <div class="post-name" id="postAuthor"></div>
            <div class="post-date" id="postDate"></div>
            <div class="post-views">ì¡°íšŒìˆ˜: <span id="viewCount"></span></div>
        </div>

        <div class="post-content" id="postContent"></div>

        <div class="like-section" id="likeSection">
            <i id="likeIcon" class="far fa-heart" style="font-size: 24px; color: #c0392b; cursor: pointer;"></i>
            <span id="likeCount"></span>
        </div>
        <div id="postControls"></div> <!-- ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ì´ ë“¤ì–´ê°ˆ ìë¦¬ -->

        <div class="divider"></div>

        <div id="commentList" class="comment-list"></div>
        
        <div class="comment-section">
            <textarea id="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            <button class="comment-btn" id="commentSubmitBtn">ëŒ“ê¸€ì“°ê¸°</button>
        </div>
    </div>

     <!-- ìµœê·¼ ë³¸ ê²Œì„ìœ¼ë¡œ ì´ë™í•˜ëŠ” ë²„íŠ¼ (ë‹ë³´ê¸° ë²„íŠ¼ ìœ„ì— ê³ ì •) -->
    <button id="recent-games-btn" class="circular-btn fixed-btn recent-fixed-btn">ğŸ‘</button> <!-- ëˆˆ ì•„ì´ì½˜ì„ ì›í˜• ë²„íŠ¼ì— ë„£ìŒ -->

    <!-- íŒì—…ì„ ì—¬ëŠ” ë²„íŠ¼ (ì˜¤ë¥¸ìª½ ì•„ë˜ ê³ ì •) -->
    <button id="open-popup-btn" class="circular-btn fixed-btn">ğŸ”</button> <!-- ë‹ë³´ê¸° ì•„ì´ì½˜ì„ ì›í˜• ë²„íŠ¼ì— ë„£ìŒ -->


    <script>
        // ê²Œì‹œê¸€ ID ê°€ì ¸ì˜¤ê¸°
        const getBoardIdFromUrl = () => {
            const params = new URLSearchParams(window.location.search);
            return params.get('boardId');
        };

        const fetchPostDetails = async () => {
            const boardId = getBoardIdFromUrl();
            const token = localStorage.getItem('token'); // JWT í† í° ê°€ì ¸ì˜¤ê¸°

            const postResponse = await fetch(`https://ludorium.store/api/user/board/${boardId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`, // JWT í† í°ì„ Authorization í—¤ë”ì— ì¶”ê°€
                    'Content-Type': 'application/json'
                }
            });

            const postData = await postResponse.json();

            if (postData.status === 200) {
                // ê²Œì‹œê¸€ ì •ë³´ ì„¤ì •
                document.getElementById('postTitle').innerText = postData.data.title;
                document.getElementById('postAuthor').innerText = postData.data.nickname;
                document.getElementById('postDate').innerText = postData.data.updatedDate;
                document.getElementById('viewCount').innerText = postData.data.hit;
                document.getElementById('postContent').innerHTML = postData.data.content;

                // ì¢‹ì•„ìš” ìˆ˜ì™€ ìƒíƒœ ì„¤ì •
                currentLikeCount = postData.data.favoriteCount;
                document.getElementById('likeCount').innerText = currentLikeCount;

                // ì¢‹ì•„ìš” ìƒíƒœì— ë”°ë¼ í•˜íŠ¸ ì•„ì´ì½˜ ì„¤ì •
                isLiked = postData.data.favoriteStatus;
                updateLikeDisplay();

                // ë‚´ê°€ ì“´ ê¸€ì´ë©´ ìˆ˜ì •, ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
                if (postData.data.status) {  // ì„œë²„ì—ì„œ ë‚´ê°€ ì“´ ê¸€ì¸ì§€ ì—¬ë¶€ë¥¼ booleanìœ¼ë¡œ ì „ë‹¬ë°›ëŠ”ë‹¤ê³  ê°€ì •
                    displayPostControls(boardId);
                }
            } else {
                console.error('ê²Œì‹œê¸€ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        };

        // ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ì¶”ê°€ í•¨ìˆ˜
        function displayPostControls(boardId) {
            const postControls = document.getElementById('postControls');
            const token = localStorage.getItem('token');
            
            // ìˆ˜ì • ë²„íŠ¼
            const editButton = document.createElement('button');
            editButton.innerText = 'ìˆ˜ì •';
            editButton.style.marginLeft = 'auto';
            editButton.style.backgroundColor = '#889491';
            editButton.style.color = 'white';
            editButton.style.border = 'none';
            editButton.style.borderRadius = '5px';
            editButton.style.padding = '10px 20px';
            editButton.style.fontSize = '16px';
            editButton.style.cursor = 'pointer';
            editButton.style.marginRight = '10px';
            
            editButton.onmouseover = () => editButton.style.backgroundColor = '#778881'; // Hover íš¨ê³¼
            editButton.onmouseleave = () => editButton.style.backgroundColor = '#889491'; // Mouse leave íš¨ê³¼

            editButton.onclick = () => {
                // edit.htmlì„ íŒì—…ìœ¼ë¡œ ì—´ ë•Œ, í† í°ì„ URL íŒŒë¼ë¯¸í„°ë¡œ í¬í•¨
                window.open(`/Graduation-work/edit.html?boardId=${boardId}&token=${encodeURIComponent(token)}`, 'Edit Post', 'width=800,height=600');
            };

            // ì‚­ì œ ë²„íŠ¼
            const deleteButton = document.createElement('button');
            deleteButton.innerText = 'ì‚­ì œ';
            deleteButton.style.marginLeft = 'auto';
            deleteButton.style.backgroundColor = '#889491';
            deleteButton.style.color = 'white';
            deleteButton.style.border = 'none';
            deleteButton.style.borderRadius = '5px';
            deleteButton.style.padding = '10px 20px';
            deleteButton.style.fontSize = '16px';
            deleteButton.style.cursor = 'pointer';

            deleteButton.onmouseover = () => deleteButton.style.backgroundColor = '#778881'; // Hover íš¨ê³¼
            deleteButton.onmouseleave = () => deleteButton.style.backgroundColor = '#889491'; // Mouse leave íš¨ê³¼

            deleteButton.onclick = async () => {
                if (confirm('ì •ë§ ì´ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    try {
                        const response = await fetch(`https://ludorium.store/api/user/board/${boardId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            alert('ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            window.location.href = 'ms_board.html'; // ì‚­ì œ í›„ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
                        } else {
                            alert('ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('ê²Œì‹œê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                }
            };

            // ë²„íŠ¼ì„ ì»¨íŠ¸ë¡¤ ì„¹ì…˜ì— ì¶”ê°€
            postControls.appendChild(editButton);
            postControls.appendChild(deleteButton);
        }

       // ëŒ“ê¸€ ê°€ì ¸ì˜¤ê¸°
        const fetchComments = async () => {
            const boardId = getBoardIdFromUrl();
            const token = localStorage.getItem('token');

            const response = await fetch(`https://ludorium.store/api/user/comment/${boardId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.status === 200) {
                const commentList = document.getElementById('commentList');
                commentList.innerHTML = ''; // ê¸°ì¡´ ëŒ“ê¸€ ì´ˆê¸°í™”

                data.data.forEach(comment => {
                    const commentItem = document.createElement('div');
                    commentItem.classList.add('comment-item');

                    const userImageUrl = comment.profileImage || 'https://i.namu.wiki/i/Bge3xnYd4kRe_IKbm2uqxlhQJij2SngwNssjpjaOyOqoRhQlNwLrR2ZiK-JWJ2b99RGcSxDaZ2UCI7fiv4IDDQ.webp';
                    const isOwner = comment.status;

                    // ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ì˜ ì´ˆê¸° ìƒíƒœ
                    commentItem.innerHTML = `
                        <img src="${userImageUrl}" alt="User" class="comment-image" />
                        <div class="comment-content">
                            <div class="comment-text-container">
                                <p class="comment-name">${comment.nickname}</p>
                                <p class="comment-text">${comment.content}</p>
                            </div>
                        </div>
                        <div class="comment-footer">
                            <p class="comment-date">${comment.updatedDate}</p>
                            <div class="comment-actions">
                                ${isOwner ? `
                                <button class="edit-btn">ìˆ˜ì •</button>
                                <button class="delete-btn">ì‚­ì œ</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    commentList.appendChild(commentItem);

                    const editBtn = commentItem.querySelector('.edit-btn');
                    const deleteBtn = commentItem.querySelector('.delete-btn');

                    // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ëŒ“ê¸€ ì‚­ì œ ìš”ì²­
                    deleteBtn?.addEventListener('click', async () => {
                        const confirmDelete = confirm("ì •ë§ë¡œ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
                        if (confirmDelete) {
                            const deleteResponse = await fetch(`https://ludorium.store/api/user/comment/${comment.commentId}`, {
                                method: 'DELETE',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                }
                            });

                            const deleteData = await deleteResponse.json();

                            if (deleteData.status === 200) {
                                alert('ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                                fetchComments(); // ëŒ“ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                            } else {
                                alert('ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                            }
                        }
                    });

                    // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ ìˆ˜ì • í™”ë©´ìœ¼ë¡œ ë³€í™˜
                    editBtn?.addEventListener('click', () => {
                        commentItem.innerHTML = `
                            <div class="comment-section">
                                <textarea id="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”">${comment.content}</textarea>
                                <button class="save-btn">ìˆ˜ì •</button>
                                <button class="cancel-btn">ì·¨ì†Œ</button>
                            </div>
                        `;

                        const saveBtn = commentItem.querySelector('.save-btn');
                        const cancelBtn = commentItem.querySelector('.cancel-btn');
                        const editTextArea = commentItem.querySelector('#commentInput');

                        // ìˆ˜ì • ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ ì›ë˜ ìƒíƒœë¡œ ë³µê·€
                        cancelBtn?.addEventListener('click', () => {
                            commentItem.innerHTML = `
                                <img src="${userImageUrl}" alt="User" class="comment-image" />
                                <div class="comment-content">
                                    <div class="comment-text-container">
                                        <p class="comment-name">${comment.nickname}</p>
                                        <p class="comment-text">${comment.content}</p>
                                    </div>
                                </div>
                                <div class="comment-footer">
                                    <p class="comment-date">${comment.updatedDate}</p>
                                    <div class="comment-actions">
                                        ${isOwner ? `
                                        <button class="edit-btn">ìˆ˜ì •</button>
                                        <button class="delete-btn">ì‚­ì œ</button>
                                        ` : ''}
                                    </div>
                                </div>
                            `;

                            // ë‹¤ì‹œ ìˆ˜ì • ë²„íŠ¼ì— ëŒ€í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                            const newEditBtn = commentItem.querySelector('.edit-btn');
                            newEditBtn?.addEventListener('click', () => {
                                editBtn.click(); // ì¬ê·€ í˜¸ì¶œí•˜ì—¬ ìˆ˜ì • ìƒíƒœë¡œ ì „í™˜
                            });
                        });

                        // ìˆ˜ì • ì™„ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ ì„œë²„ì— PATCH ìš”ì²­
                        saveBtn?.addEventListener('click', async () => {
                            const updatedContent = editTextArea.value;

                            // PATCH ìš”ì²­ ì „ì†¡
                            const patchResponse = await fetch(`https://ludorium.store/api/user/comment/${comment.commentId}`, {
                                method: 'PATCH',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    content: updatedContent
                                })
                            });

                            const patchData = await patchResponse.json();

                            if (patchData.status === 200) {
                                commentItem.innerHTML = `
                                    <img src="${userImageUrl}" alt="User" class="comment-image" />
                                    <div class="comment-content">
                                        <div class="comment-text-container">
                                            <p class="comment-name">${comment.nickname}</p>
                                            <p class="comment-text">${updatedContent}</p>
                                        </div>
                                    </div>
                                    <div class="comment-footer">
                                        <p class="comment-date">${new Date().toLocaleString()}</p>
                                        <div class="comment-actions">
                                            ${isOwner ? `
                                            <button class="edit-btn">ìˆ˜ì •</button>
                                            <button class="delete-btn">ì‚­ì œ</button>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            } else {
                                alert('ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                            }
                        });
                    });
                });
            }
        };

        // ëŒ“ê¸€ ì‘ì„±
        const submitComment = async () => {
            const boardId = getBoardIdFromUrl();
            const token = localStorage.getItem('token'); // JWT í† í° ê°€ì ¸ì˜¤ê¸°

            const commentContent = document.getElementById('commentInput').value;
            const response = await fetch(`https://ludorium.store/api/user/comment/${boardId}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content: commentContent })
            });

            if (response.ok) {
                document.getElementById('commentInput').value = ''; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                fetchComments(); // ëŒ“ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } else {
                alert('ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        };

        let isLiked = false; // ì‚¬ìš©ìê°€ ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ëŠ”ì§€ ì—¬ë¶€
        let currentLikeCount = parseInt(document.getElementById('likeCount').innerText) || 0; // í˜„ì¬ ì¢‹ì•„ìš” ìˆ˜

        // ì¢‹ì•„ìš” í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        document.getElementById('likeSection').addEventListener('click', async () => {
            const boardId = getBoardIdFromUrl(); // boardId ê°€ì ¸ì˜¤ê¸°
            const token = localStorage.getItem('token'); // JWT í† í° ê°€ì ¸ì˜¤ê¸°

            // ì¢‹ì•„ìš” ìƒíƒœì— ë”°ë¼ API í˜¸ì¶œ
            const url = `https://ludorium.store/api/user/board/${boardId}/favorite`;

            try {
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    isLiked = !isLiked; // ì¢‹ì•„ìš” ìƒíƒœ í† ê¸€

                    // ì¢‹ì•„ìš” ìˆ˜ ì—…ë°ì´íŠ¸
                    if (isLiked) {
                        currentLikeCount += 1; // ì¢‹ì•„ìš” ìˆ˜ ì¦ê°€
                    } else {
                        currentLikeCount -= 1; // ì¢‹ì•„ìš” ìˆ˜ ê°ì†Œ
                    }
                    updateLikeDisplay(); // ì¢‹ì•„ìš” ìˆ˜ì™€ ìƒíƒœ ì—…ë°ì´íŠ¸
                } else {
                    alert('ì¢‹ì•„ìš” ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // ì¢‹ì•„ìš” ìˆ˜ì™€ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateLikeDisplay() {
            const likeCountDisplay = document.getElementById('likeCount');
            const likeIcon = document.getElementById('likeIcon');

            likeCountDisplay.innerText = currentLikeCount; // ì¢‹ì•„ìš” ìˆ˜ ì—…ë°ì´íŠ¸

            // í•˜íŠ¸ ì•„ì´ì½˜ ìƒíƒœ ì—…ë°ì´íŠ¸
            if (isLiked) {
                likeIcon.classList.remove('far'); // ë¹„ì–´ìˆëŠ” í•˜íŠ¸ ì œê±°
                likeIcon.classList.add('fas'); // ê½‰ ì°¬ í•˜íŠ¸ ì¶”ê°€
            } else {
                likeIcon.classList.remove('fas'); // ê½‰ ì°¬ í•˜íŠ¸ ì œê±°
                likeIcon.classList.add('far'); // ë¹„ì–´ìˆëŠ” í•˜íŠ¸ ì¶”ê°€
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        document.getElementById('commentSubmitBtn').addEventListener('click', submitComment);

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê²Œì‹œê¸€ê³¼ ëŒ“ê¸€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        window.onload = async () => {
            await fetchPostDetails();
            await fetchComments();
        };
         // íŒì—…ì°½ì„ ì—´ê³  í† í°ì„ ì „ë‹¬í•˜ëŠ” í•¨ìˆ˜
        function openPopupWithToken() {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                return;
            }
            const popupUrl = `https://gameforge-ai-server.streamlit.app/?token=${token}`;
            const popupWindow = window.open(popupUrl, 'PopupWindow', 'width=600,height=600');
            if (!popupWindow || popupWindow.closed || typeof popupWindow.closed === 'undefined') {
                alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
            }
        }

        // ìµœê·¼ ë³¸ ê²Œì„ í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
        function goToRecentGames() {
            window.location.href = 'recentGames.html';
        }

        // ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.getElementById('open-popup-btn').addEventListener('click', openPopupWithToken);
        document.getElementById('recent-games-btn').addEventListener('click', goToRecentGames);
    </script>
</body>
</html>
