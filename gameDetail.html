<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>game forge - ê²Œì„ ìƒì„¸</title>
    <link rel="stylesheet" href="gameDetail.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div id="header-placeholder"></div>
    <div class="container">
      <div class="game-detail">
        <div class="game-header">
          <h1 id="gameName">undefined</h1>
          <p id="categories">undefined</p>
        </div>
        <div class="game-content">
          <div class="game-left">
            <video id="gameVideo" controls autoplay muted>
              <source id="videoSource" src="" type="video/webm" />
              ë™ì˜ìƒì„ ì¬ìƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
            </video>
            <p id="gameDescription"></p>
          </div>
          <div class="game-right">
            <img
              id="gameImage"
              src="https://via.placeholder.com/150"
              alt="ê²Œì„ ì´ë¯¸ì§€"
            />
            <p id="release-date">ì¶œì‹œì¼:</p>
            <p id="distributor">ë°°ê¸‰ì‚¬:</p>
            <p id="gamePrice">ê°€ê²©: â‚© undefined</p>
            <button id="action-button" class="cart-btn" onclick="handleAction()">ê·¸ë£¹ì— ë‹´ê¸°</button>
          </div>
        </div>
      </div>

      <h2>ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­</h2>
      <div class="system-requirements">
        <div class="tabs">
          <button class="tab active" onclick="showRequirements('windows')">
            Windows
          </button>
          <button class="tab" onclick="showRequirements('mac')">macOS</button>
          <button class="tab" onclick="showRequirements('linux')">
            Linux
          </button>
        </div>
        <div id="windows" class="requirements-section">
          <div class="specs-container">
            <div class="specs-min" id="windowsMin"></div>
            <div class="specs-max" id="windowsMax"></div>
          </div>
        </div>

        <div id="mac" class="requirements-section" style="display: none">
          <div class="specs-container">
            <div class="specs-min" id="macMin"></div>
            <div class="specs-max" id="macMax"></div>
          </div>
        </div>

        <div id="linux" class="requirements-section" style="display: none">
          <div class="specs-container">
            <div class="specs-min" id="linuxMin"></div>
            <div class="specs-max" id="linuxMax"></div>
          </div>
        </div>
      </div>

      <h2>ë¦¬ë·°</h2>
      <div class="reviews">
        <p class="average-rating">
          í‰ê·  í‰ì  <span class="rating" id="averageRating">4.7</span>
          <span class="review-count" id="reviewCount">(56)</span>
        </p>

        <div id="reviewsContainer"></div>
      </div>
    </div>
     <!-- ìµœê·¼ ë³¸ ê²Œì„ìœ¼ë¡œ ì´ë™í•˜ëŠ” ë²„íŠ¼ (ëˆë³´ê¸° ë²„íŠ¼ ìœ„ì— ê³ ì •) -->
    <button id="recent-games-btn" class="circular-btn fixed-btn recent-fixed-btn">ğŸ‘</button> <!-- ëˆˆ ì•„ì´ì½˜ì„ ì›í˜• ë²„íŠ¼ì— ë„£ìŒ -->

    <!-- íŒì—…ì„ ì—¬ëŠ” ë²„íŠ¼ (ì˜¤ë¥¸ìª½ ì•„ë˜ ê³ ì •) -->
    <button id="open-popup-btn" class="circular-btn fixed-btn">ğŸ”</button> <!-- ë‹ë³´ê¸° ì•„ì´ì½˜ì„ ì›í˜• ë²„íŠ¼ì— ë„£ìŒ -->
    <footer>
      <div class="footer-content">
        <p>&copy; ëŒ€ì§„ëŒ€í•™êµ ë²¤ì²˜ ì¡¸ì—…ì‘í’ˆ.</p>
      </div>
    </footer>
    <script src="gameDetail.js"></script>
    <script src="auth.js"></script>
    <script>
      const serverUrl = "https://ludorium.store";

      async function fetchGameDetails(gameId) {
        try {
          const token = localStorage.getItem('token');
          const headers = {
            'accept': '*/*',
          };

          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }

          const response = await fetch(`${serverUrl}/api/user/game/${gameId}`, {
            headers: headers
          });

          if (!response.ok) {
            throw new Error("ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.");
          }
          const result = await response.json();

          console.log("ê²Œì„ ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¨ ê²°ê³¼:", result);

          if (result && result.data) {
            const game = result.data;

            const gameNameElement = document.getElementById("gameName");
            if (gameNameElement) {
              gameNameElement.innerText = game.gameName || "ì œëª© ì—†ìŒ";
            }

            if (game.gameCategoryList && game.gameCategoryList.length > 0) {
              const categoriesElement = document.getElementById("categories");
              if (categoriesElement) {
                categoriesElement.innerHTML = "";
                game.gameCategoryList.forEach((category) => {
                  const categorySpan = document.createElement("span");
                  categorySpan.className = "category-box";
                  categorySpan.innerText = category;
                  categoriesElement.appendChild(categorySpan);
                });
              }
            } else {
              const categoriesElement = document.getElementById("categories");
              if (categoriesElement) {
                categoriesElement.innerText = "ì¹´í…Œê³ ë¦¬: ì•Œ ìˆ˜ ì—†ìŒ";
              }
            }

            const gameDescriptionElement = document.getElementById("gameDescription");
            if (gameDescriptionElement) {
              gameDescriptionElement.innerHTML = game.gameDc || "ê²Œì„ ì„¤ëª… ì—†ìŒ";
            }

            const gamePriceElement = document.getElementById("gamePrice");
            const actionButton = document.getElementById("action-button");
            if (gamePriceElement && actionButton) {
              if (game.originalPrice !== undefined && game.discountPrice !== undefined) {
                if (game.originalPrice !== game.discountPrice) {
                  gamePriceElement.innerHTML = `ì •ìƒê°€: â‚© ${game.originalPrice}<br>íŒë§¤ê°€: â‚© ${game.discountPrice}`;
                  actionButton.innerText = "ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸°";
                  actionButton.onclick = () => addToCart(gameId);
                } else {
                  gamePriceElement.innerText = game.discountPrice === 0 ? "ë¬´ë£Œ" : `ê°€ê²©: â‚© ${game.discountPrice}`;
                  actionButton.innerText = game.discountPrice === 0 ? "ë¬´ë£Œë¡œ ë°›ê¸°" : "ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸°";
                  actionButton.onclick = game.discountPrice === 0 ? () => buyGame(gameId) : () => addToCart(gameId);
                }
              } else {
                gamePriceElement.innerText = "ê°€ê²© ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
              }
            }

            const gameImageElement = document.getElementById("gameImage");
            if (gameImageElement && game.gameImageList && game.gameImageList.length > 0) {
              gameImageElement.src = game.gameImageList[0];
              if (game.gameImageList.length > 1) {
                const videoElement = document.getElementById("gameVideo");
                const videoSourceElement = document.getElementById("videoSource");

                if (videoElement && videoSourceElement) {
                  videoElement.style.display = "block";
                  videoSourceElement.src = game.gameImageList[1];
                  videoElement.load();
                }
              }
            }

            // ì¶œì‹œì¼ ë° ë°°ê¸‰ì‚¬ ì •ë³´ ì—…ë°ì´íŠ¸
            const releaseDateElement = document.getElementById("release-date");
            if (releaseDateElement) {
              releaseDateElement.innerText = `ì¶œì‹œì¼: ${game.releaseDate ? game.releaseDate.split('T')[0] : "ì•Œ ìˆ˜ ì—†ìŒ"}`;
            }

            const distributorElement = document.getElementById("distributor");
            if (distributorElement) {
              distributorElement.innerText = `ë°°ê¸‰ì‚¬: ${game.publisher || "ì•Œ ìˆ˜ ì—†ìŒ"}`;
            }

            window.currentGame = {
              gameId: gameId,
              gameName: game.gameName,
              gamePrice: game.discountPrice,
            };

            fetchReviews(gameId);
            handleSystemRequirements(game);
          } else {
            console.error("Error: ì‘ë‹µì˜ data í•„ë“œê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.", result);
          }
        } catch (error) {
          console.error("ê²Œì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
      }

      // ê²Œì„ì„ ë¬´ë£Œë¡œ êµ¬ë§¤í•˜ëŠ” í•¨ìˆ˜
      async function buyGame(gameId) {
        try {
          const token = localStorage.getItem('token');
          if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
            window.location.href = 'login.html';
            return;
          }

          const response = await fetch(`${serverUrl}/api/user/order/purchase-now/${gameId}`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
            }
          });

          if (!response.ok) {
            throw new Error('ê²Œì„ êµ¬ë§¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }

          alert('ê²Œì„ì´ êµ¬ë§¤ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (error) {
          console.error('ê²Œì„ êµ¬ë§¤ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
          alert('ì´ë¯¸ êµ¬ë§¤í•œ ê²Œì„ì…ë‹ˆë‹¤.');
        }
      }

      // ê²Œì„ í›„ê¸° ë¶ˆëŸ¬ì˜¤ê¸°
      async function fetchReviews(gameId) {
        try {
          console.log("ì¡°íšŒí•  gameId:", gameId);
          const response = await fetch(`${serverUrl}/api/user/review/${gameId}`);
          if (!response.ok) {
            throw new Error("í›„ê¸° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
          }
          const result = await response.json();

          console.log("ê²Œì„ í›„ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¨ ê²°ê³¼:", result);

          if (result && result.data && result.data.responseDtoList) {
            const reviews = result.data.responseDtoList;
            const reviewsContainer = document.getElementById("reviewsContainer");
            const averageRating = document.getElementById("averageRating");
            const reviewCount = document.getElementById("reviewCount");

            if (reviewsContainer && averageRating && reviewCount) {
              reviewsContainer.innerHTML = "";

              if (reviews.length === 0) {
                reviewsContainer.innerHTML = "<p>ì•„ì§ ë¦¬ë·°ê°€ ì—†ëŠ” ìƒí’ˆì…ë‹ˆë‹¤.</p>";
                averageRating.innerText = "0";
                reviewCount.innerText = "(0)";
              } else {
                averageRating.innerText = result.data.avgRating;
                reviewCount.innerText = `(${reviews.length})`;

                reviews.forEach((review) => {
                  const reviewDiv = document.createElement("div");
                  reviewDiv.className = "review-item";
                  reviewDiv.innerHTML = `
                    ${review.profileImage || 'profile.jpg'}
                    <div class="review-content">
                      <p class="review-rating">â­ ${review.rating}</p>
                      <div class="review-text-container">
                        <p class="review-name">${review.nickname}</p>
                        <p class="review-text">${review.content}</p>
                      </div>
                    </div>
                    <div class="review-footer">
                      <p class="review-date">${review.createdDate}</p>
                      ${
                        review.nickname.trim() ===
                        (window.currentUserNickname
                          ? window.currentUserNickname.trim()
                          : "")
                          ? `
                      <div class="review-actions">
                        <button class="edit-btn" onclick="editReview(${review.reviewId}, '${review.content}')">ìˆ˜ì •</button>
                        <button class="delete-btn" onclick="deleteReview(${review.reviewId})">ì‚­ì œ</button>
                      </div>
                      `
                          : ""
                      }
                    </div>
                  `;
                  reviewsContainer.appendChild(reviewDiv);
                });
              }
            }
          } else {
            console.error("Error: ì‘ë‹µì˜ data í•„ë“œê°€ ì˜¬ë°”ë¥¸ í˜•íƒœê°€ ì•„ë‹™ë‹ˆë‹¤.", result);
          }
        } catch (error) {
          console.error("ê²Œì„ í›„ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
      }

      async function addToCart(gameId) {
        try {
          console.log("ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€í•  ê²Œì„ ID:", gameId); // ê²Œì„ ID ì¶œë ¥

          // gameIdê°€ ìœ íš¨í•œì§€ í™•ì¸
          if (!gameId) {
            throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ê²Œì„ IDì…ë‹ˆë‹¤.');
          }

          const token = localStorage.getItem('token');
          if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
            window.location.href = 'login.html';
            return;
          }

          // ì¤‘ë³µ ì¶”ê°€ ë°©ì§€ ë¡œì§ (ì¥ë°”êµ¬ë‹ˆì— ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸)
          const cartResponse = await fetch(`${serverUrl}/api/user/cart`, {
            headers: {
              'Authorization': `Bearer ${token}`,
            },
          });

          if (cartResponse.ok) {
            const cartData = await cartResponse.json();
            if (cartData.some(item => item.gameId === gameId)) {
              alert('ì¥ë°”êµ¬ë‹ˆì— ì´ë¯¸ ë‹´ê¸´ ê²Œì„ì…ë‹ˆë‹¤.');
              return;
            }
          }

          // ì¥ë°”êµ¬ë‹ˆì— ê²Œì„ ì¶”ê°€
          const response = await fetch(`${serverUrl}/api/user/cart/${gameId}`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
          });

          if (!response.ok) {
            const errorData = await response.json();
            console.error('ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ì˜¤ë¥˜ ë°ì´í„°:', errorData);
            throw new Error('ì¥ë°”êµ¬ë‹ˆì— ì´ë¯¸ ë‹´ê¸´ ê²Œì„ì…ë‹ˆë‹¤.');
          }

          alert('ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (error) {
          console.error('ì¥ë°”êµ¬ë‹ˆì— ê²Œì„ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
          alert('ì¥ë°”êµ¬ë‹ˆì— ì´ë¯¸ ë‹´ê¸´ ê²Œì„ì…ë‹ˆë‹¤.');
        }
      }

      function showRequirements(os) {
        document.querySelectorAll('.requirements-section').forEach(section => {
          section.style.display = 'none';
        });

        document.querySelectorAll('.tabs button').forEach(button => {
          button.classList.remove('active');
        });

        const selectedSection = document.getElementById(os);
        if (selectedSection) {
          selectedSection.style.display = 'block';
        }

        document.querySelector(`.tabs button[onclick="showRequirements('${os}')"]`).classList.add('active');
      }

      function handleSystemRequirements(game) {
        const tabsContainer = document.querySelector('.tabs');

        if (game.windowsMinSpecifications || game.windowsMaxSpecifications) {
          document.getElementById('windowsMin').innerHTML = game.windowsMinSpecifications || '';
          document.getElementById('windowsMax').innerHTML = game.windowsMaxSpecifications || '';
        } else {
          tabsContainer.querySelector('button[onclick="showRequirements(\'windows\')"]').style.display = 'none';
          document.getElementById('windows').style.display = 'none';
        }

        if (game.macMinSpecifications || game.macMaxSpecifications) {
          document.getElementById('macMin').innerHTML = game.macMinSpecifications || '';
          document.getElementById('macMax').innerHTML = game.macMaxSpecifications || '';
        } else {
          tabsContainer.querySelector('button[onclick="showRequirements(\'mac\')"]').style.display = 'none';
          document.getElementById('mac').style.display = 'none';
        }

        if (game.linuxMinSpecifications || game.linuxMaxSpecifications) {
          document.getElementById('linuxMin').innerHTML = game.linuxMinSpecifications || '';
          document.getElementById('linuxMax').innerHTML = game.linuxMaxSpecifications || '';
        } else {
          tabsContainer.querySelector('button[onclick="showRequirements(\'linux\')"]').style.display = 'none';
          document.getElementById('linux').style.display = 'none';
        }
      }

      const urlParams = new URLSearchParams(window.location.search);
      const gameId = urlParams.get("gameId");

      document.addEventListener("DOMContentLoaded", function () {
        fetch("header.html")
          .then((response) => response.text())
          .then((data) => {
            document.getElementById("header-placeholder").innerHTML = data;
            checkLoginStatus();
          })
          .catch((error) => console.error("í—¤ë” ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error));

        if (gameId) {
          fetchGameDetails(gameId);
        } else {
          console.error("Error: gameIdê°€ URLì— ì—†ìŠµë‹ˆë‹¤.");
        }
      });
      // íŒì—…ì°½ì„ ì—´ê³  í† í°ì„ ì „ë‹¬í•˜ëŠ” í•¨ìˆ˜
        function openPopupWithToken() {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                return;
            }
            const popupUrl = `https://gameforge-ai-server.streamlit.app/?token=${token}`;
            const popupWindow = window.open(popupUrl, 'PopupWindow', 'width=600,height=600');
            if (!popupWindow || popupWindow.closed || typeof popupWindow.closed === 'undefined') {
                alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
            }
        }

        // ìµœê·¼ ë³¸ ê²Œì„ í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
        function goToRecentGames() {
            window.location.href = 'recentGames.html';
        }

        // ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.getElementById('open-popup-btn').addEventListener('click', openPopupWithToken);
        document.getElementById('recent-games-btn').addEventListener('click', goToRecentGames);
    </script>
  </body>
</html>
