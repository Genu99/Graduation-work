<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game Forge - 게임 상세</title>
    <link rel="stylesheet" href="gameDetail.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&family=Material+Icons&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- 헤더 자리 표시자 -->
    <div id="header-placeholder"></div>
    <div class="container">
      <div class="game-detail">
      <div class="game-detail">
        <div class="game-header">
          <h1 id="gameName">undefined</h1>
          <p id="categoryName">카테고리: undefined</p>
        </div>
        <div class="game-content">
          <div class="game-left">
            <img id="gameImage" src="https://via.placeholder.com/150" alt="게임 이미지" />
            <video id="gameVideo" controls style="display: none; max-width: 100%; height: auto;">
              <source id="videoSource" src="" type="video/webm" />
              동영상을 재생할 수 없습니다.
            </video>
          </div>
          <div class="game-right">
            <p id="gameDescription">undefined</p>
            <p id="gamePrice">가격: ₩ undefined</p>
            <button class="cart-btn" onclick="addToCart()">장바구니에 담기</button>
          </div>
        </div>
      </div>
      
        
      </div>
    </div>
    <div class="reviews-container">
        <h2>게임 리뷰</h2>
        <div id="reviews-section">
          <!-- 리뷰가 여기에 표시됩니다 -->
        </div>
      </div>
      <footer>
        <div class="footer-content">
          <p>&copy; 대진대학교 벤처 졸업작품.</p>
        </div>
      </footer>

    <script src="auth.js"></script>
    <script>
      const serverUrl = 'https://ludorium.store';

      // 게임 상세 정보 불러오기
      async function fetchGameDetails(gameId) {
        try {
          const response = await fetch(`${serverUrl}/api/user/game/${gameId}`);
          if (!response.ok) {
            throw new Error('네트워크 응답에 문제가 있습니다.');
          }
          const result = await response.json();

          if (result && result.data) {
            const game = result.data;

            document.getElementById('gameName').innerText = game.gameName || '제목 없음';
            document.getElementById('categoryName').innerText = `카테고리: ${game.categoryName || '알 수 없음'}`;
            document.getElementById('gameDescription').innerHTML = game.gameDc || '게임 설명 없음';

            if (game.originalPrice !== game.discountPrice) {
              document.getElementById('gamePrice').innerHTML = `정상가: ₩ ${game.originalPrice}<br>판매가: ₩ ${game.discountPrice}`;
            } else {
              document.getElementById('gamePrice').innerText = game.discountPrice === 0 ? '무료' : `가격: ₩ ${game.discountPrice}`;
            }

            if (game.gameImageList && game.gameImageList.length > 0) {
              document.getElementById('gameImage').src = game.gameImageList[0];
              if (game.gameImageList.length > 1) {
                const videoElement = document.getElementById('gameVideo');
                const videoSourceElement = document.getElementById('videoSource');

                videoElement.style.display = 'block';
                videoSourceElement.src = game.gameImageList[1];
                videoElement.load(); // 비디오 요소에 새 소스를 로드하여 적용
              }
            }

            window.currentGame = {
              gameId: gameId,
              gameName: game.gameName,
              gamePrice: game.discountPrice,
            };

            addRecentGame(gameId, game.gameName, game.discountPrice, game.gameImageList[0] || '');
            loadReviews(gameId);
          } else {
            console.error('Error: 응답의 data 필드가 비어 있습니다.', result);
          }
        } catch (error) {
          console.error('게임 데이터를 불러오는 중 오류 발생:', error);
        }
      }

      // 리뷰 불러오기
      async function loadReviews(gameId) {
        try {
          const response = await fetch(`${serverUrl}/api/user/review/${gameId}`);
          if (!response.ok) {
            throw new Error('리뷰 데이터를 불러오는 중 오류 발생');
          }

          const result = await response.json();
          const reviewsSection = document.getElementById('reviews-section');

          if (result && result.responseDataList && result.responseDataList.length > 0) {$1} else {reviewsSection.innerHTML = '<p>작성된 리뷰가 없습니다.</p>';}
        } catch (error) {
          console.error('리뷰 데이터를 불러오는 중 오류 발생:', error);
        }
      }

      // 리뷰 제출
      

        try {
          const response = await fetch(`${serverUrl}/api/user/review`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              content: reviewText,
              rating: reviewRating,
              gameId: gameId
            })
          });

          if (!response.ok) {
            throw new Error('리뷰 작성에 실패했습니다.');
          }

          alert('리뷰가 성공적으로 작성되었습니다.');
          loadReviews(gameId);
        } catch (error) {
          console.error('리뷰 작성 중 오류 발생:', error);
          alert('리뷰 작성 중 오류가 발생했습니다. 다시 시도해 주세요.');
        }
      }

      // 리뷰 수정
      async function editReview(reviewId) {
        const newReviewText = prompt('수정할 리뷰 내용을 입력하세요:');
        const newReviewRating = prompt('수정할 평점을 입력하세요 (1-5):');

        if (!newReviewText || isNaN(newReviewRating) || newReviewRating < 1 || newReviewRating > 5) {
          alert('리뷰 내용과 평점을 정확히 입력해주세요. 평점은 1에서 5 사이여야 합니다.');
          return;
        }

        try {
          const response = await fetch(`${serverUrl}/api/user/review/${reviewId}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              content: newReviewText,
              rating: Number(newReviewRating)
            })
          });

          if (!response.ok) {
            throw new Error('리뷰 수정에 실패했습니다.');
          }

          alert('리뷰가 성공적으로 수정되었습니다.');
          loadReviews(window.currentGame.gameId);
        } catch (error) {
          console.error('리뷰 수정 중 오류 발생:', error);
          alert('리뷰 수정 중 오류가 발생했습니다. 다시 시도해 주세요.');
        }
      }

      // 리뷰 삭제
      async function deleteReview(reviewId) {
        if (!confirm('정말로 이 리뷰를 삭제하시겠습니까?')) {
          return;
        }

        try {
          const response = await fetch(`${serverUrl}/api/user/review/${reviewId}`, {
            method: 'DELETE'
          });

          if (!response.ok) {
            throw new Error('리뷰 삭제에 실패했습니다.');
          }

          alert('리뷰가 성공적으로 삭제되었습니다.');
          loadReviews(window.currentGame.gameId);
        } catch (error) {
          console.error('리뷰 삭제 중 오류 발생:', error);
          alert('리뷰 삭제 중 오류가 발생했습니다. 다시 시도해 주세요.');
        }
      }

      function addToCart() {
        if (!window.currentGame) {
          console.error('Error: 게임 정보가 없습니다.');
          return;
        }

        const { gameId, gameName, gamePrice } = window.currentGame;
        let cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];

        if (!cartItems.find((item) => item.gameId === gameId)) {
          cartItems.push({
            gameId,
            gameName,
            gamePrice,
          });
        }

        localStorage.setItem('cartItems', JSON.stringify(cartItems));
        alert('장바구니에 추가되었습니다.');
      }

      function addRecentGame(gameId, gameName, gamePrice, gameImageUrl) {
        let recentGames = JSON.parse(localStorage.getItem('recentGames')) || [];

        if (!recentGames.find((game) => game.gameId === gameId)) {
          recentGames.push({
            gameId,
            gameName,
            gamePrice,
            gameImageUrl
          });

          if (recentGames.length > 5) {
            recentGames.shift();
          }

          localStorage.setItem('recentGames', JSON.stringify(recentGames));
          console.log('로컬 스토리지에 저장된 recentGames:', recentGames);
        }
      }

      const urlParams = new URLSearchParams(window.location.search);
      const gameId = urlParams.get('gameId');

      document.addEventListener("DOMContentLoaded", function() {
        fetch("header.html")
          .then(response => response.text())
          .then(data => {
            document.getElementById("header-placeholder").innerHTML = data;
            checkLoginStatus();
          })
          .catch(error => console.error("헤더 로드 중 오류 발생:", error));

        if (gameId) {
          fetchGameDetails(gameId);
        } else {
          console.error('Error: gameId가 URL에 없습니다.');
        }
      });
    </script>
  </body>
</html>
