<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game Forge - ê²Œì‹œíŒ</title>
    <link rel="stylesheet" href="ms_board.css">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <style>
/* íŒì—… ë²„íŠ¼ ìŠ¤íƒ€ì¼ë§ */
        #open-popup-btn,
        #recent-games-btn {
            position: fixed;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #007BFF;
            color: white;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s, transform 0.3s;
            z-index: 1000;
        }

        #open-popup-btn:hover,
        #recent-games-btn:hover {
            background-color: #0056b3;
            transform: scale(1.1);
        }

        .circular-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background-color: #007bff;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s;
        }

        .circular-btn:hover {
            background-color: #0056b3;
        }

        .fixed-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
        }

        .recent-fixed-btn {
            bottom: 90px;
            right: 20px;
        }
</style>
    
  </head>
  <body>
    <!-- í—¤ë”ë¥¼ ë³„ë„ì˜ íŒŒì¼ë¡œ ê°€ì ¸ì˜´ -->
    <div id="header"></div>
    <script>
        // header.html íŒŒì¼ì„ ë¡œë“œí•˜ì—¬ í—¤ë”ë¥¼ ì¶”ê°€
        fetch("header.html")
            .then(response => response.text())
            .then(data => {
                document.getElementById("header").innerHTML = data;
                checkLoginStatus();
            })
            .catch(error => console.error("í—¤ë” ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error));
    </script>
    <script src="auth.js"></script>
    <!-- ë¡œê·¸ì¸ ìƒíƒœ ê´€ë¦¬ë¥¼ ìœ„í•œ ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ -->
    <div class="container">
      <!-- ì¢Œì¸¡ ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
      <div class="nav-left">
        <ul>
            <li>
                <a href="#notice" id="notice-link">ê³µì§€ì‚¬í•­</a>
            </li>
            <li>
                <a href="#freeboard" id="freeboard-link" class="active">ììœ ê²Œì‹œíŒ</a>
            </li>
        </ul>
    </div>
    
      <!-- ê²Œì‹œíŒ ë‚´ìš© -->
      <div class="content">
        <!-- ê²Œì‹œíŒ ì´ë¦„ ë° ì •ë ¬ ì˜µì…˜ -->
        <div class="board-header">
          <h2>ê²Œì‹œíŒ</h2>
          <div class="sort-options">
            <select id="order">
              <option value="recent">ìµœì‹ ìˆœ</option>
              <option value="hit">ì¡°íšŒìˆ˜ìˆœ</option>
            </select>
          </div>
        </div>
        <table id="boardTable" class="table">
          <thead>
            <tr class="main-header">
              <th class="main-header-num">ë²ˆí˜¸</th>
              <th class="main-header-title">ì œëª©</th>
              <th class="main-header-name">ì‘ì„±ì</th>
              <th class="main-header-date">ì‘ì„±ë‚ ì§œ</th>
              <th class="main-header-like">ì¡°íšŒìˆ˜</th>
            </tr>
          </thead>
          <tbody>
            <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ˆ ê²Œì‹œê¸€ ëª©ë¡ -->
          </tbody>
        </table>
         <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
         <div class="pagination" id="pagination">
            <!-- í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë  ê³³ -->
        </div>
        <div class="button-container">
          <button id="write-button" onclick="location.href='write.html'" style="display:none;">ê¸€ì“°ê¸°</button>
        </div>
        <!-- ê²€ìƒ‰ì°½ ë° ê²€ìƒ‰ ì˜µì…˜ -->
        <div class="search-container">
            <div class="search-bar">
                <select id="search-type">
                    <option value="title">ì œëª©</option>
                    <option value="content">ë‚´ìš©</option>
                    <option value="titleContent">ì œëª©+ë‚´ìš©</option>
                </select>
                <input type="text" id="search-input" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
                <button id="search-button">ê²€ìƒ‰</button>
            </div>
        </div>
    </div>
       <!-- ìµœê·¼ ë³¸ ê²Œì„ìœ¼ë¡œ ì´ë™í•˜ëŠ” ë²„íŠ¼ (ë‹ë³´ê¸° ë²„íŠ¼ ìœ„ì— ê³ ì •) -->
    <button id="recent-games-btn" class="circular-btn fixed-btn recent-fixed-btn">ğŸ‘</button> <!-- ëˆˆ ì•„ì´ì½˜ì„ ì›í˜• ë²„íŠ¼ì— ë„£ìŒ -->

    <!-- íŒì—…ì„ ì—¬ëŠ” ë²„íŠ¼ (ì˜¤ë¥¸ìª½ ì•„ë˜ ê³ ì •) -->
    <button id="open-popup-btn" class="circular-btn fixed-btn">ğŸ”</button> <!-- ë‹ë³´ê¸° ì•„ì´ì½˜ì„ ì›í˜• ë²„íŠ¼ì— ë„£ìŒ -->

    <script>
        let currentPage = 1; // í˜„ì¬ í˜ì´ì§€
        const maxButtons = 10; // í˜ì´ì§€ ë²„íŠ¼ì˜ ìµœëŒ€ ê°œìˆ˜
        let startPage = 1; // ì‹œì‘ í˜ì´ì§€
        let endPage = maxButtons; // ë í˜ì´ì§€

        // ê²€ìƒ‰ ë²„íŠ¼ ë° ì…ë ¥ í•„ë“œ
        const orderSelect = document.getElementById('order');
        const searchButton = document.getElementById('search-button');
        const searchInput = document.getElementById('search-input');
        const searchTypeSelect = document.getElementById('search-type');
        const noticeLink = document.getElementById('notice-link');
        const freeboardLink = document.getElementById('freeboard-link');
        const writeButton = document.getElementById('write-button');

        // ê²€ìƒ‰ì–´ ë° ê²€ìƒ‰ ìœ í˜•
        let currentSearchKeyword = '';
        let currentSearchType = '';

        // ë§í¬ í´ë¦­ ì‹œ active í´ë˜ìŠ¤ë¥¼ ì„¤ì •í•˜ëŠ” í•¨ìˆ˜
    function setActiveLink(activeLink) {
        noticeLink.classList.remove('active');
        freeboardLink.classList.remove('active');
        activeLink.classList.add('active');
    }

    // í˜„ì¬ í™œì„±í™”ëœ ì¹´í…Œê³ ë¦¬ IDë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function getActiveCategoryId() {
        return noticeLink.classList.contains('active') ? 2 : 1; // ê³µì§€ì‚¬í•­: 2, ììœ ê²Œì‹œíŒ: 1
    }

    // ê³µì§€ì‚¬í•­ í´ë¦­ ì‹œ
    noticeLink.addEventListener('click', function(event) {
        event.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë§‰ê¸°
        setActiveLink(noticeLink); // active í´ë˜ìŠ¤ ì„¤ì •
        fetchBoardList(2); // ê³µì§€ì‚¬í•­ì€ categoryId 2ë²ˆìœ¼ë¡œ í˜¸ì¶œ
        writeButton.style.display = 'none'; // ê³µì§€ì‚¬í•­ì—ì„œëŠ” ê¸€ì“°ê¸° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        checkAdminRole(); // ROLE_ADMIN ì—¬ë¶€ ì²´í¬
    });

    // ììœ ê²Œì‹œíŒ í´ë¦­ ì‹œ
    freeboardLink.addEventListener('click', function(event) {
        event.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë§‰ê¸°
        setActiveLink(freeboardLink); // active í´ë˜ìŠ¤ ì„¤ì •
        fetchBoardList(1); // ììœ ê²Œì‹œíŒì€ categoryId 1ë²ˆìœ¼ë¡œ í˜¸ì¶œ
        writeButton.style.display = 'block'; // ììœ ê²Œì‹œíŒì—ì„œëŠ” ê¸€ì“°ê¸° ë²„íŠ¼ í•­ìƒ ë³´ì´ê¸°
    });

    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì‹œ ììœ ê²Œì‹œíŒì„ ê¸°ë³¸ ì„ íƒìœ¼ë¡œ ì„¤ì •
    window.onload = function () {
        setActiveLink(freeboardLink); // ììœ ê²Œì‹œíŒ ë§í¬ì— active í´ë˜ìŠ¤ ì„¤ì •
        fetchBoardList(1); // ììœ ê²Œì‹œíŒ ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
        writeButton.style.display = 'block'; // ììœ ê²Œì‹œíŒì—ì„œëŠ” ê¸€ì“°ê¸° ë²„íŠ¼ í•­ìƒ ë³´ì´ê¸°
    };
        // ì •ë ¬ ì˜µì…˜ ë³€ê²½ ì‹œ ê²Œì‹œíŒ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        orderSelect.addEventListener('change', function() {
            const activeCategory = getActiveCategoryId(); // í˜„ì¬ í™œì„±í™”ëœ ì¹´í…Œê³ ë¦¬ ID
            fetchBoardList(activeCategory, 1, orderSelect.value, currentSearchType, currentSearchKeyword); // ì„ íƒëœ ì •ë ¬ ì˜µì…˜ìœ¼ë¡œ ê²Œì‹œíŒ ë¦¬ìŠ¤íŠ¸ í˜¸ì¶œ
        });

        // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ
        searchButton.addEventListener('click', function() {
            currentSearchKeyword = searchInput.value.trim(); // ì…ë ¥ëœ ê²€ìƒ‰ì–´
            currentSearchType = searchTypeSelect.value; // ì„ íƒëœ ê²€ìƒ‰ ìœ í˜•

            if (currentSearchKeyword) {
                const activeCategory = getActiveCategoryId(); // í˜„ì¬ í™œì„±í™”ëœ ì¹´í…Œê³ ë¦¬ ID
                fetchBoardList(activeCategory, 1, orderSelect.value, currentSearchType, currentSearchKeyword); // ê²€ìƒ‰ì–´ì™€ ê²€ìƒ‰ ìœ í˜•ì„ ì „ë‹¬
            } else {
                alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            }
        });

        // ROLE_ADMIN ì—¬ë¶€ ì²´í¬ í•¨ìˆ˜
        function checkAdminRole() {
            const userRole = sessionStorage.getItem('userRole'); // ì‚¬ìš©ì ì—­í•  ê°€ì ¸ì˜¤ê¸° (ì˜ˆ: ROLE_USER, ROLE_ADMIN)
            if (userRole === 'ROLE_ADMIN') {
                writeButton.style.display = 'block'; // ROLE_ADMINì¸ ê²½ìš° ê¸€ì“°ê¸° ë²„íŠ¼ ë³´ì´ê¸°
            } else {
                writeButton.style.display = 'none'; // ROLE_ADMINì´ ì•„ë‹Œ ê²½ìš° ê¸€ì“°ê¸° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            }
        }

        // ê²Œì‹œíŒ ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
        async function fetchBoardList(categoryId = 1, page = 1, orderBy = '', searchType = '', searchKeyword = '') {
            console.log(page);
            const response = await fetch(`https://ludorium.store/api/user/board/${categoryId}/list?page=${page}&orderBy=${orderBy}&searchType=${searchType}&searchKeyword=${searchKeyword}`);
            const data = await response.json();

            if (data.status === 200 && data.code === 'SUCCESS') {
                const boards = data.data.content;
                const tbody = document.querySelector("#boardTable tbody");
                tbody.innerHTML = ''; // í…Œì´ë¸” ì´ˆê¸°í™”

                boards.forEach(board => {
                    const row = document.createElement('tr');

                    // ê²Œì‹œíŒ ID
                    const boardIdCell = document.createElement('td');
                    boardIdCell.textContent = board.boardId;
                    row.appendChild(boardIdCell);

                    // ì œëª© ì—´: í´ë¦­ ì‹œ boardDetail.htmlë¡œ ì´ë™
                    const titleCell = document.createElement('td');
                    titleCell.className = 'main-header-title'; // í´ë˜ìŠ¤ ì¶”ê°€
                    titleCell.innerHTML = `<a href="boardDetail.html?boardId=${board.boardId}">${board.title}</a> <span class="comment-count">(${board.commentCount})</span>`;
                    row.appendChild(titleCell);

                    // ë‹‰ë„¤ì„
                    const nicknameCell = document.createElement('td');
                    nicknameCell.textContent = board.nickname;
                    row.appendChild(nicknameCell);

                    // ë“±ë¡ ë‚ ì§œ
                    const regDate = document.createElement('td');
                    const dateOnly = new Date(board.createdDate).toISOString().slice(0, 10);
                    regDate.textContent = dateOnly;
                    row.appendChild(regDate);

                    // ì¡°íšŒìˆ˜
                    const hitCell = document.createElement('td');
                    hitCell.textContent = board.hit;
                    row.appendChild(hitCell);

                    tbody.appendChild(row);
                });

                // í˜ì´ì§€ë„¤ì´ì…˜ ì²˜ë¦¬
                const totalPages = data.data.totalPages;
                updatePagination(totalPages);
            } else {
                console.error("ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", data);
            }
        }

        // í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updatePagination(totalPages) {
            const paginationContainer = document.getElementById('pagination');
            paginationContainer.innerHTML = '';

            // í˜ì´ì§€ ë²„íŠ¼ì˜ ì‹œì‘ê³¼ ë ê³„ì‚°
            startPage = Math.floor((currentPage - 1) / maxButtons) * maxButtons + 1;
            endPage = Math.min(startPage + maxButtons - 1, totalPages);

            // ì´ì „ ë²„íŠ¼
            if (startPage > 1) {
                const prevButton = document.createElement('button');
                prevButton.textContent = '<';
                prevButton.addEventListener('click', () => {
                    currentPage = startPage - 1;
                    fetchBoardList(getActiveCategoryId(), currentPage, orderSelect.value, currentSearchType, currentSearchKeyword);
                });
                paginationContainer.appendChild(prevButton);
            }

            // í˜ì´ì§€ ë²„íŠ¼ ë§Œë“¤ê¸°
            for (let i = startPage; i <= endPage; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.className = i === currentPage ? 'active' : '';
                button.disabled = i === currentPage; // í˜„ì¬ í˜ì´ì§€ ë²„íŠ¼ì€ ë¹„í™œì„±í™”
                button.addEventListener('click', () => {
                    currentPage = i;
                    fetchBoardList(getActiveCategoryId(), currentPage, orderSelect.value, currentSearchType, currentSearchKeyword);
                });
                paginationContainer.appendChild(button);
            }

            // ë‹¤ìŒ ë²„íŠ¼
            if (endPage < totalPages) {
                const nextButton = document.createElement('button');
                nextButton.textContent = '>';
                nextButton.addEventListener('click', () => {
                    currentPage = endPage + 1;
                    fetchBoardList(getActiveCategoryId(), currentPage, orderSelect.value, currentSearchType, currentSearchKeyword);
                });
                paginationContainer.appendChild(nextButton);
            }
        }

        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        fetchBoardList();
      // íŒì—…ì°½ì„ ì—´ê³  í† í°ì„ ì „ë‹¬í•˜ëŠ” í•¨ìˆ˜
        function openPopupWithToken() {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                return;
            }
            const popupUrl = `https://gameforge-ai-server.streamlit.app/?token=${token}`;
            const popupWindow = window.open(popupUrl, 'PopupWindow', 'width=600,height=600');
            if (!popupWindow || popupWindow.closed || typeof popupWindow.closed === 'undefined') {
                alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
            }
        }

        // ìµœê·¼ ë³¸ ê²Œì„ í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
        function goToRecentGames() {
            window.location.href = 'recentGames.html';
        }

        // ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.getElementById('open-popup-btn').addEventListener('click', openPopupWithToken);
        document.getElementById('recent-games-btn').addEventListener('click', goToRecentGames);
    </script>
  </body>
</html>
