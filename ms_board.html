<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game Forge - 게시판</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Same styles as before */
      /* Add all your previous styles here */
    </style>
  </head>
  <body>
    <!-- 헤더를 동적으로 불러오기 -->
    <div id="header"></div>

    <div class="container">
      <!-- 좌측 네비게이션 바 -->
      <nav>
        <ul>
          <li>
            <a href="#notice" id="notice-link">공지사항</a>
          </li>
          <li>
            <a href="#freeboard" id="freeboard-link" class="active">자유게시판</a>
          </li>
        </ul>
      </nav>

      <!-- 게시판 내용 -->
      <div class="content">
        <!-- 게시판 이름 및 정렬 옵션 -->
        <div class="board-header">
          <div class="sort-options">
            <select id="order">
              <option value="recent">최신순</option>
              <option value="hit">조회수순</option>
            </select>
          </div>
        </div>
        <table id="boardTable" class="table">
          <thead>
            <tr class="main-header">
              <td class="main-header-num">번호</td>
              <td class="main-header-title">제목</td>
              <td class="main-header-name">작성자</td>
              <td class="main-header-date">작성날짜</td>
              <td class="main-header-like">조회수</td>
            </tr>
          </thead>
          <tbody>
            <!-- 동적으로 채워질 게시글 목록 -->
          </tbody>
        </table>
         <!-- 페이지네이션 -->
         <div class="pagination" id="pagination">
            <!-- 페이지네이션 버튼이 동적으로 생성될 곳 -->
        </div>
        <table>
          <tr>
            <td>
              <button id="write-button" onclick="location.href='write.html'">글쓰기</button>
            </td>
          </tr>
        </table>
        <!-- 검색창 및 검색 옵션 -->
        <div class="search-container">
          <div class="search-bar">
            <select id="search-type">
              <option value="title">제목</option>
              <option value="content">내용</option>
              <option value="titleContent">제목+내용</option>
            </select>
            <input type="text" id="search-input" placeholder="검색어를 입력하세요" />
            <button id="search-button">검색</button>
          </div>
        </div>
      </div>

      <script src="auth.js"></script>
      <script>
        // 헤더를 동적으로 불러오기
        fetch('header.html')
          .then(response => response.text())
          .then(data => {
            document.getElementById('header').innerHTML = data;
          })
          .catch(error => console.error('Error loading header:', error));

        // 토큰 관리 (auth.js를 통해 가져온다)
        let token = '';
        auth.getToken().then(t => {
          token = t;
          // Token을 사용한 API 호출 추가
          fetchBoardList();
        });

        let currentPage = 1; // 현재 페이지
        const maxButtons = 10; // 페이지 버튼의 최대 개수
        let startPage = 1; // 시작 페이지
        let endPage = maxButtons; // 끝 페이지

        // 검색 버튼 및 입력 필드
        const orderSelect = document.getElementById('order');
        const searchButton = document.getElementById('search-button');
        const searchInput = document.getElementById('search-input');
        const searchTypeSelect = document.getElementById('search-type');
        const noticeLink = document.getElementById('notice-link');
        const freeboardLink = document.getElementById('freeboard-link');

        // 검색어 및 검색 유형
        let currentSearchKeyword = '';
        let currentSearchType = '';

        // 링크 클릭 시 active 클래스를 설정하는 함수
        function setActiveLink(activeLink) {
          noticeLink.classList.remove('active');
          freeboardLink.classList.remove('active');
          activeLink.classList.add('active');
        }

        // 현재 활성화된 카테고리 ID를 가져오는 함수
        function getActiveCategoryId() {
          return noticeLink.classList.contains('active') ? 2 : 1; // 공지사항: 2, 자유게시판: 1
        }

        // 게시판 리스트 불러오기
        async function fetchBoardList(categoryId = 1, page = 1, orderBy = '', searchType = '', searchKeyword = '') {
          const response = await fetch(`https://ludorium.store/api/user/board/${categoryId}/list?page=${page}&orderBy=${orderBy}&searchType=${searchType}&searchKeyword=${searchKeyword}`, {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          const data = await response.json();

          if (data.status === 200 && data.code === 'SUCCESS') {
            const boards = data.data.content;
            const tbody = document.querySelector("#boardTable tbody");
            tbody.innerHTML = ''; // 테이블 초기화

            boards.forEach(board => {
              const row = document.createElement('tr');

              // 게시판 ID
              const boardIdCell = document.createElement('td');
              boardIdCell.textContent = board.boardId;
              row.appendChild(boardIdCell);

              // 제목 열: 클릭 시 boardDetail.html로 이동
              const titleCell = document.createElement('td');
              titleCell.className = 'main-header-title'; // 클래스 추가
              titleCell.innerHTML = `<a href="boardDetail.html?boardId=${board.boardId}">${board.title}</a> <span class="comment-count">(${board.commentCount})</span>`;
              row.appendChild(titleCell);

              // 닉네임
              const nicknameCell = document.createElement('td');
              nicknameCell.textContent = board.nickname;
              row.appendChild(nicknameCell);

              // 등록 날짜
              const regDate = document.createElement('td');
              const dateOnly = new Date(board.updatedDate).toISOString().slice(0, 10);
              regDate.textContent = dateOnly;
              row.appendChild(regDate);

              // 조회수
              const hitCell = document.createElement('td');
              hitCell.textContent = board.hit;
              row.appendChild(hitCell);

              tbody.appendChild(row);
            });

            // 페이지네이션 처리
            const totalPages = data.data.totalPages;
            updatePagination(totalPages);
          } else {
            console.error("게시글 불러오기 실패:", data);
          }
        }

        // 페이지네이션 업데이트 함수
        function updatePagination(totalPages) {
          const paginationContainer = document.getElementById('pagination');
          paginationContainer.innerHTML = '';

          // 페이지 버튼의 시작과 끝 계산
          startPage = Math.floor((currentPage - 1) / maxButtons) * maxButtons + 1;
          endPage = Math.min(startPage + maxButtons - 1, totalPages);

          // 이전 버튼
          if (startPage > 1) {
            const prevButton = document.createElement('button');
            prevButton.textContent = '<';
            prevButton.addEventListener('click', () => {
              currentPage = startPage - 1;
              fetchBoardList(getActiveCategoryId(), currentPage, orderSelect.value, currentSearchType, currentSearchKeyword);
            });
            paginationContainer.appendChild(prevButton);
          }

          // 페이지 버튼 만들기
          for (let i = startPage; i <= endPage; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.className = i === currentPage ? 'active' : '';
            button.disabled = i === currentPage; // 현재 페이지 버튼은 비활성화
            button.addEventListener('click', () => {
              currentPage = i;
              fetchBoardList(getActiveCategoryId(), currentPage, orderSelect.value, currentSearchType, currentSearchKeyword);
            });
            paginationContainer.appendChild(button);
          }

          // 다음 버튼
          if (endPage < totalPages) {
            const nextButton = document.createElement('button');
            nextButton.textContent = '>';
            nextButton.addEventListener('click', () => {
              currentPage = endPage + 1;
              fetchBoardList(getActiveCategoryId(), currentPage, orderSelect.value, currentSearchType, currentSearchKeyword);
            });
            paginationContainer.appendChild(nextButton);
          }
        }

        // 초기 데이터 로드 (헤더 추가 후에 fetchBoardList 호출)
      </script>
  </body>
</html>
