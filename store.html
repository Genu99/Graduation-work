<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game Forge - 상점</title>
    <link rel="stylesheet" href="store.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&family=Material+Icons&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- 헤더 자리 표시자 -->
    <div id="header-placeholder"></div>
    
    <div class="container">
      <!-- Filter and sorting section -->
      <div class="filters">
        <div class="sort">
          <select id="sortOrder">
            <option value="rating">평점순</option>
            <option value="recent">최신순</option>
          </select>
        </div>
        <div class="genre-filter">
          <p>장르별 검색</p>
          <label><input type="radio" name="genre" value="1" /> 무료</label><br />
          <label><input type="radio" name="genre" value="2" /> 액션</label><br />
          <label><input type="radio" name="genre" value="3" /> 어드벤처</label><br />
          <label><input type="radio" name="genre" value="4" checked /> RPG</label><br />
          <label><input type="radio" name="genre" value="5" /> MMO</label><br />
          <label><input type="radio" name="genre" value="6" /> 레이싱</label><br />
          <label><input type="radio" name="genre" value="7" /> 스포츠</label><br />
          <label><input type="radio" name="genre" value="8" /> 전략</label><br />
          <label><input type="radio" name="genre" value="9" /> 시뮬레이션</label><br />
          <label><input type="radio" name="genre" value="10" /> 인디</label><br />
          <label><input type="radio" name="genre" value="11" /> 캐주얼</label>
        </div>
        <!-- 검색 창 추가 -->
        <div class="search-bar">
          <i class="material-icons">search</i>
          <input type="text" id="searchKeyword" placeholder="게임 검색" />
        </div>
      </div>

      <!-- Product listing section -->
      <div class="product-list">
        <h2>구름 님을 위한 추천 게임</h2>
        <div class="product-grid">
          <!-- 게임 리스트가 여기에 동적으로 추가됩니다 -->
        </div>
        <div class="pagination">
          <button id="prevPage">이전 페이지</button>
          <span id="currentPage">1</span>
          <button id="nextPage">다음 페이지</button>
        </div>
      </div>
    </div>
    <footer>
      <div class="footer-content">
        <p>&copy; 대진대학교 벤처 졸업작품.</p>
      </div>
    </footer>

    <script src="auth.js"></script>
    <script>
      // Store the server URL
      const serverUrl = 'https://ludorium.store';
      let currentPage = 0;
      const pageSize = 8;

      // Function to fetch game list by category ID
      async function fetchGamesByCategory(categoryId, page = 0, orderBy = 'rating', searchKeyword = '') {
        try {
          // Fetch data from the API
          const response = await fetch(
            `${serverUrl}/api/user/game/${categoryId}/list?page=${page}&size=${pageSize}&orderBy=${orderBy}&searchKeyword=${encodeURIComponent(searchKeyword)}`
          );
          if (!response.ok) {
            throw new Error('네트워크 응답에 문제가 있습니다.');
          }
          const result = await response.json();

          // Log the result to understand the structure
          console.log('API 응답:', result);

          // Extract the games array from the response
          let games = [];
          if (result.data && Array.isArray(result.data.content)) {
            games = result.data.content;
          } else {
            console.error('Error: 응답의 data 필드가 올바른 배열이 아닙니다.', result);
            return;
          }

          // Render game data
          renderGameList(games);
        } catch (error) {
          console.error('Error fetching games:', error);
        }
      }

      // Function to render game list
      function renderGameList(games) {
        const productGrid = document.querySelector('.product-grid');
        productGrid.innerHTML = ''; // Clear existing games

        games.forEach((game) => {
          const gameCard = `
            <div class="product-card">
              <a href="gameDetail.html?gameId=${game.gameId}" class="game-title-link">
                <img src="${game.gameImageUrl || 'https://via.placeholder.com/150'}" alt="${game.gameName || '게임 이미지'}" />
                <p class="product-title">${game.gameName || '제목 없음'}</p>
              </a>
              <p class="product-price">정상가: ₩ ${game.originalPrice}</p>
              <p class="sale-price">판매가: ₩ ${game.discountPrice}</p>
              <div class="rating">
                <i class="material-icons">star</i><span>${game.rating || 0}</span>
              </div>
              <button class="cart-btn" onclick="addToCart(${game.gameId})">장바구니</button>
            </div>
          `;
          productGrid.innerHTML += gameCard;
        });
      }

      // Function to add game to cart
      function addToCart(gameId) {
        console.log(`게임 ${gameId}을(를) 장바구니에 추가합니다.`);
        // 여기에 장바구니에 게임을 추가하는 로직을 구현하세요
      }

      // Event listener for genre filter changes
      document.querySelectorAll('.genre-filter input[type="radio"]').forEach((radio) => {
        radio.addEventListener('change', function () {
          const categoryId = this.value;
          currentPage = 0;
          const orderBy = document.getElementById('sortOrder').value;
          const searchKeyword = document.getElementById('searchKeyword').value;
          fetchGamesByCategory(categoryId, currentPage, orderBy, searchKeyword);
        });
      });

      // Event listener for sort order changes
      document.getElementById('sortOrder').addEventListener('change', function () {
        const categoryId = document.querySelector('.genre-filter input[type="radio"]:checked').value;
        const orderBy = this.value;
        const searchKeyword = document.getElementById('searchKeyword').value;
        fetchGamesByCategory(categoryId, currentPage, orderBy, searchKeyword);
      });

      // Event listener for search input
      document.getElementById('searchKeyword').addEventListener('input', function () {
        const categoryId = document.querySelector('.genre-filter input[type="radio"]:checked').value;
        const orderBy = document.getElementById('sortOrder').value;
        const searchKeyword = this.value;
        fetchGamesByCategory(categoryId, currentPage, orderBy, searchKeyword);
      });

      // Pagination event listeners
      document.getElementById('prevPage').addEventListener('click', () => {
        if (currentPage > 0) {
          currentPage--;
          const categoryId = document.querySelector('.genre-filter input[type="radio"]:checked').value;
          const orderBy = document.getElementById('sortOrder').value;
          const searchKeyword = document.getElementById('searchKeyword').value;
          fetchGamesByCategory(categoryId, currentPage, orderBy, searchKeyword);
          document.getElementById('currentPage').innerText = currentPage + 1;
        }
      });

      document.getElementById('nextPage').addEventListener('click', () => {
        currentPage++;
        const categoryId = document.querySelector('.genre-filter input[type="radio"]:checked').value;
        const orderBy = document.getElementById('sortOrder').value;
        const searchKeyword = document.getElementById('searchKeyword').value;
        fetchGamesByCategory(categoryId, currentPage, orderBy, searchKeyword);
        document.getElementById('currentPage').innerText = currentPage + 1;
      });

      // Initial fetch for the default category
      document.addEventListener("DOMContentLoaded", function() {
        fetch("header.html")
          .then(response => response.text())
          .then(data => {
            document.getElementById("header-placeholder").innerHTML = data;
            checkLoginStatus();
          })
          .catch(error => console.error("헤더 로드 중 오류 발생:", error));

        fetchGamesByCategory(4); // Default to RPG category on page load
      });
    </script>
  </body>
</html>
