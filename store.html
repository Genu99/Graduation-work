<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Game Forge - ìƒì </title>
  <link rel="stylesheet" href="store.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&family=Material+Icons&display=swap" rel="stylesheet">
  <style>
      /* íŒì—… ë²„íŠ¼ ìŠ¤íƒ€ì¼ë§ */
      #open-popup-btn,
      #recent-games-btn {
          position: fixed;
          width: 60px;
          height: 60px;
          border-radius: 50%;
          background-color: #007BFF;
          color: white;
          border: none;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
          font-size: 24px;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: background-color 0.3s, transform 0.3s;
          z-index: 1000;
      }

      #open-popup-btn:hover,
      #recent-games-btn:hover {
          background-color: #0056b3;
          transform: scale(1.1);
      }

      .circular-btn {
          width: 60px;
          height: 60px;
          border-radius: 50%;
          border: none;
          background-color: #007bff;
          color: white;
          font-size: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          transition: background-color 0.3s;
      }

      .circular-btn:hover {
          background-color: #0056b3;
      }

      .fixed-btn {
          position: fixed;
          bottom: 20px;
          right: 20px;
      }

      .recent-fixed-btn {
          bottom: 90px;
          right: 20px;
      }
  </style>
</head>
<body>
  <!-- í—¤ë” ìë¦¬ í‘œì‹œì -->
  <div id="header-placeholder"></div>

  <div class="container">
    <!-- í•„í„° ë° ì •ë ¬ ì„¹ì…˜ -->
    <div class="filters">
      <div class="sort">
        <select id="sortOrder">
          <option value="orderByPopular">ì¶”ì²œìˆœ</option>
          <option value="orderByRecent">ìµœì‹ ìˆœ</option>
          <option value="orderBySales">êµ¬ë§¤ ë§ì€ìˆœ</option>
          <option value="orderByPriceAsc">ë‚®ì€ ê°€ê²©ìˆœ</option>
          <option value="orderByPriceDesc">ë†’ì€ ê°€ê²©ìˆœ</option>
        </select>
      </div>
      <div class="genre-filter">
        <p>ì¥ë¥´ë³„ ê²€ìƒ‰</p>
        <label><input type="radio" name="genre" value="0" checked> ì „ì²´</label><br>
        <label><input type="radio" name="genre" value="1"> ë¬´ë£Œ</label><br>
        <label><input type="radio" name="genre" value="5"> MMO</label><br>
        <label><input type="radio" name="genre" value="4"> RPG</label><br>
        <label><input type="radio" name="genre" value="6"> ë ˆì´ì‹±</label><br>
        <label><input type="radio" name="genre" value="7"> ìŠ¤í¬ì¸ </label><br>
        <label><input type="radio" name="genre" value="9"> ì‹œë®¬ë ˆì´ì…˜</label><br>
        <label><input type="radio" name="genre" value="2"> ì•¡ì…˜</label><br>
        <label><input type="radio" name="genre" value="3"> ì–´ë“œë²¤ì²˜</label><br>
        <label><input type="radio" name="genre" value="10"> ì¸ë””</label><br>
        <label><input type="radio" name="genre" value="8"> ì „ëµ</label><br>
        <label><input type="radio" name="genre" value="11"> ìºì£¼ì–¼</label>
      </div>
    </div>

    <!-- ìƒí’ˆ ëª©ë¡ ì„¹ì…˜ -->
    <div class="product-list">
      <h2 id="game-list-title">ê²Œì„</h2>
         <!-- ê²€ìƒ‰ ì°½ ì¶”ê°€ -->
      <div class="product-search-bar">
        <i class="material-icons">search</i>
        <input type="text" id="searchKeyword" placeholder="ê²Œì„ ê²€ìƒ‰">
      </div>
      <div class="product-grid">
        <!-- ê²Œì„ ë¦¬ìŠ¤íŠ¸ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
      </div>
      <div class="pagination" id="pagination">
        <!-- í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
      </div>
    </div>
  </div>

  <!-- ìš°ì¸¡ í•˜ë‹¨ì— ìµœê·¼ ë³¸ ê²Œì„ ì•„ì´ì½˜ -->
  <div id="recent-game-icon" style="position: fixed; bottom: 20px; right: 20px; display: none;">
    <img id="recent-game-image" src="" alt="ìµœê·¼ ë³¸ ê²Œì„" style="width: 50px; height: 50px; border-radius: 50%;">
  </div>
   <!-- ìµœê·¼ ë³¸ ê²Œì„ìœ¼ë¡œ ì´ë™í•˜ëŠ” ë²„íŠ¼ (ë‹ë³´ê¸° ë²„íŠ¼ ìœ„ì— ê³ ì •) -->
    <button id="recent-games-btn" class="circular-btn fixed-btn recent-fixed-btn">ğŸ‘</button> <!-- ëˆˆ ì•„ì´ì½˜ì„ ì›í˜• ë²„íŠ¼ì— ë„£ìŒ -->

    <!-- íŒì—…ì„ ì—¬ëŠ” ë²„íŠ¼ (ì˜¤ë¥¸ìª½ ì•„ë˜ ê³ ì •) -->
    <button id="open-popup-btn" class="circular-btn fixed-btn">ğŸ”</button> <!-- ë‹ë³´ê¸° ì•„ì´ì½˜ì„ ì›í˜• ë²„íŠ¼ì— ë„£ìŒ -->

  <footer>
    <div class="footer-content">
      <p>&copy; ëŒ€ì§„ëŒ€í•™êµ ë²¤ì²˜ ì¡¸ì—…ì‘í’ˆ.</p>
    </div>
  </footer>

  <script src="auth.js"></script>
  <script>
    const serverUrl = 'https://ludorium.store'; // serverUrl ì •ì˜ ì¶”ê°€

    let currentPage = 1; // í˜„ì¬ í˜ì´ì§€
    const maxButtons = 10; // í˜ì´ì§€ ë²„íŠ¼ì˜ ìµœëŒ€ ê°œìˆ˜
    let startPage = 1; // ì‹œì‘ í˜ì´ì§€
    let endPage = maxButtons; // ë í˜ì´ì§€

    // ì¹´í…Œê³ ë¦¬ IDë¡œ ê²Œì„ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    async function fetchGamesByCategory(categoryId, page = 1, orderBy = 'orderByPopular', searchKeyword = '') {
      try {
        let allGames = [];
        let totalPages = 0;

        const response = await fetch(
          `${serverUrl}/api/user/game/${categoryId}/list?page=${page}&orderBy=${orderBy}&searchKeyword=${encodeURIComponent(searchKeyword)}`
        );

        if (!response.ok) {
          throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.');
        }

        const result = await response.json();

        // ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„° ì½˜ì†”ì— ì¶œë ¥
        console.log('ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°:', result);

        if (result.data && Array.isArray(result.data.content)) {
          allGames = result.data.content;
          totalPages = result.data.totalPages;
        } else {
          console.error('Error: ì‘ë‹µì˜ data í•„ë“œê°€ ì˜¬ë°”ë¥¸ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤.', result);
          return;
        }

        renderGameList(allGames);
        updatePagination(totalPages);
      } catch (error) {
        console.error('ê²Œì„ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
      }
    }

    // ê²Œì„ ëª©ë¡ì„ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
    function renderGameList(games) {
      const productGrid = document.querySelector('.product-grid');
      productGrid.innerHTML = ''; // ê¸°ì¡´ ê²Œì„ ëª©ë¡ ì‚­ì œ

      games.forEach((game) => {
        let priceInfo = '';
        if (game.originalPrice === game.discountPrice) {
          if (game.discountPrice === 0) {
            priceInfo = '<p class="sale-price" style="color: #4865dc">ë¬´ë£Œ</p>';
          } else {
            priceInfo = `<p class="sale-price" style="color: #4865dc">â‚© ${game.discountPrice}</p>`;
          }
        } else {
          priceInfo = `
            <p class="product-price">ì •ì‚°ê°€: â‚© ${game.originalPrice}</p>
            <p class="sale-price">íŒë§¤ê°€: â‚© ${game.discountPrice}</p>
             <p class="discount-percentage"> ${game.discountPercentage}%</p>
          `;
        }

        // ì¹´í…Œê³ ë¦¬ ì •ë³´ ì¶”ê°€ - í´ë¦­ë§í¬ê°€ ì•„ë‹ˆë¼ ê·¸ëƒ¥ í…ìŠ¤íŠ¸ í˜•íƒœë¡œ í‘œì‹œ
        const categoryText = game.gameCategoryList.map(category => `<span class="category-text" style="color: #555; background-color: #e9ecef; padding: 2px 6px; margin: 2px; border-radius: 4px;">${category}</span>`).join(' ');
        
        let actionButton = '';
        if (game.inCart) {
          actionButton = `<button class="cart-btn" style="background-color: #6c757d; color: #fff; border: none; padding: 10px 16px; border-radius: 4px; cursor: pointer;" onclick="showPopup('ì´ë¯¸ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ ê²Œì„ì…ë‹ˆë‹¤.')">ì¥ë°”êµ¬ë‹ˆì— ë‹´ê²¨ì§„ ê²Œì„ì…ë‹ˆë‹¤</button>`;
        } else if (game.purchased) {
          actionButton = `<button class="buy-btn" style="background-color: #28a745; color: #fff; border: none; padding: 10px 16px; border-radius: 4px; cursor: pointer;" onclick="showPopup('ì´ë¯¸ êµ¬ë§¤í•œ ê²Œì„ì…ë‹ˆë‹¤.')">ì´ë¯¸ êµ¬ë§¤í•œ ê²Œì„ì…ë‹ˆë‹¤</button>`;
        } else {
          actionButton = game.discountPrice === 0 ?
            `<button class="buy-btn" style="background-color: #28a745; color: #fff; border: none; padding: 10px 16px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease;" onclick="buyGame('${game.gameId}')">ë¬´ë£Œë¡œ ë°›ê¸°</button>` :
            `<button class="cart-btn" style="background-color: #6c757d; color: #fff; border: none; padding: 10px 16px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease;" onclick="addToCart('${game.gameId}')">ì¥ë°”êµ¬ë‹ˆ</button>`;
        }

        const gameCard = `
          <div class="product-card" style="border: 1px solid #e0e0e0; border-radius: 10px; padding: 16px; margin: 16px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); transition: box-shadow 0.3s ease;">
            <a href="#" class="game-title-link" style="text-decoration: none; color: inherit;" onclick="handleGameClick(event, '${game.gameId}')">
              <img src="${game.gameImageUrl || 'https://via.placeholder.com/150'}" alt="${game.gameName || 'ê²Œì„ ì´ë¯¸ì§€'}" style="width: 100%; height: auto; border-radius: 10px; transition: transform 0.3s ease;" />
              <p class="product-title" style="font-size: 1.2em; font-weight: bold; margin: 12px 0;">${game.gameName || 'ì œëª© ì—†ìŒ'}</p>
            </a>
            <div class="product-category">
              ${categoryText}
            </div>
            ${priceInfo}
            <div class="rating" style="display: flex; align-items: center; margin: 8px 0;">
              <i class="material-icons" style="color: #ffc107; margin-right: 4px;">star</i><span style="font-size: 1em;">${game.rating || 0} (${game.reviewCount || 0})</span>
            </div>
            ${actionButton}
          </div>
        `;
        productGrid.innerHTML += gameCard;
      });
    }

    // ê²Œì„ì„ ë¬´ë£Œë¡œ êµ¬ë§¤í•˜ëŠ” í•¨ìˆ˜
    async function buyGame(gameId) {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
          window.location.href = 'login.html';
          return;
        }

        const response = await fetch(`${serverUrl}/api/user/order/purchase-now/${gameId}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          }
        });

        if (!response.ok) {
          throw new Error('ê²Œì„ êµ¬ë§¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }

        alert('ê²Œì„ì´ êµ¬ë§¤ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (error) {
        console.error('ê²Œì„ êµ¬ë§¤ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        alert('ì´ë¯¸ êµ¬ë§¤í•œ ê²Œì„ì…ë‹ˆë‹¤..');
      }
    }

    // ì¥ë°”êµ¬ë‹ˆì— ê²Œì„ ì¶”ê°€ í•¨ìˆ˜
    async function addToCart(gameId) {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
          window.location.href = 'login.html';
          return;
        }

        const response = await fetch(`${serverUrl}/api/user/cart/${gameId}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        });

        if (response.status === 409) {
          showPopup('ì´ë¯¸ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ ê²Œì„ì´ê±°ë‚˜ êµ¬ë§¤í•œê²Œì„ì…ë‹ˆë‹¤.');
          return;
        }

        if (!response.ok) {
          throw new Error('ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }

        alert('ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (error) {
        console.error('ì¥ë°”êµ¬ë‹ˆì— ê²Œì„ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        alert('ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
    }

    // í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updatePagination(totalPages) {
      const paginationContainer = document.getElementById('pagination');
      paginationContainer.innerHTML = '';

      if (startPage > 1) {
        const prevButton = document.createElement('button');
        prevButton.textContent = '<';
        prevButton.addEventListener('click', () => {
          startPage -= maxButtons;
          endPage -= maxButtons;
          currentPage = startPage;
          const categoryId = document.querySelector('.genre-filter input[type="radio"]:checked').value;
          const orderBy = document.getElementById('sortOrder').value;
          const searchKeyword = document.getElementById('searchKeyword').value;
          fetchGamesByCategory(categoryId, currentPage, orderBy, searchKeyword);
          updatePagination(totalPages);
        });
        paginationContainer.appendChild(prevButton);
      }

      for (let i = startPage; i <= Math.min(endPage, totalPages); i++) {
        const button = document.createElement('button');
        button.textContent = i;
        button.className = i === currentPage ? 'active' : '';
        button.disabled = i === currentPage;
        button.addEventListener('click', () => {
          currentPage = i;
          const categoryId = document.querySelector('.genre-filter input[type="radio"]:checked').value;
          const orderBy = document.getElementById('sortOrder').value;
          const searchKeyword = document.getElementById('searchKeyword').value;
          fetchGamesByCategory(categoryId, currentPage, orderBy, searchKeyword);
          updatePagination(totalPages);
        });
        paginationContainer.appendChild(button);
      }

      if (endPage < totalPages) {
        const nextButton = document.createElement('button');
        nextButton.textContent = '>';
        nextButton.addEventListener('click', () => {
          startPage += maxButtons;
          endPage += maxButtons;
          currentPage = startPage;
          const categoryId = document.querySelector('.genre-filter input[type="radio"]:checked').value;
          const orderBy = document.getElementById('sortOrder').value;
          const searchKeyword = document.getElementById('searchKeyword').value;
          fetchGamesByCategory(categoryId, currentPage, orderBy, searchKeyword);
          updatePagination(totalPages);
        });
        paginationContainer.appendChild(nextButton);
      }
    }

    // ìµœê·¼ ë³¸ ê²Œì„ ì•„ì´ì½˜ í‘œì‹œ í•¨ìˆ˜
    async function showRecentGameIcon() {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          console.warn('ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
          return;
        }

        // ìµœê·¼ ë³¸ ê²Œì„ ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•œ API í˜¸ì¶œ
        const response = await fetch(`${serverUrl}/api/user/mypage/recent-list`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          }
        });

        if (!response.ok) {
          throw new Error('ìµœê·¼ ë³¸ ê²Œì„ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }

        const result = await response.json();

        // ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„° ì½˜ì†”ì— ì¶œë ¥
        console.log('ì„œë²„ì—ì„œ ë°›ì€ ìµœê·¼ ë³¸ ê²Œì„ ë°ì´í„°:', result);

        // ìµœê·¼ ë³¸ ê²Œì„ ë°ì´í„°ê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°
        if (result && result.length > 0) {
          const recentGameData = result[result.length - 1]; // ê°€ì¥ ìµœê·¼ì— ë³¸ ê²Œì„
          const recentGameIcon = document.getElementById('recent-game-icon');
          const recentGameImage = document.getElementById('recent-game-image');
          recentGameImage.src = recentGameData.gameImageUrl;
          recentGameIcon.style.display = 'block';
          recentGameIcon.onclick = () => {
            window.location.href = `gameDetail.html?gameId=${recentGameData.gameId}`; // í•´ë‹¹ ê²Œì„ì˜ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
          };
        }
      } catch (error) {
        console.error('ìµœê·¼ ë³¸ ê²Œì„ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
      }
    }

    // ê²€ìƒ‰ì°½ì—ì„œ ì—”í„°ë¥¼ ëˆ„ë¥´ë©´ ê²Œì„ ëª©ë¡ ê²€ìƒ‰
    document.getElementById('searchKeyword').addEventListener('keyup', function(event) {
      if (event.key === 'Enter') {
        const searchKeyword = this.value;
        const selectedGenre = document.querySelector('input[name="genre"]:checked').value;
        const sortOrder = document.getElementById('sortOrder').value;
        currentPage = 1; // í˜ì´ì§€ë¥¼ 1ë¡œ ì´ˆê¸°í™”
        fetchGamesByCategory(selectedGenre, currentPage, sortOrder, searchKeyword);
      }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ ì¹´í…Œê³ ë¦¬(ì „ì²´)ë¡œ ê²Œì„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    document.addEventListener("DOMContentLoaded", function() {
      fetch("header.html")
        .then(response => response.text())
        .then(data => {
          document.getElementById("header-placeholder").innerHTML = data;
          checkLoginStatus();
        })
        .catch(error => console.error("í—¤ë” ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error));

      fetchGamesByCategory(0); // í˜ì´ì§€ ë¡œë“œ ì‹œ ì „ì²´ ì¹´í…Œê³ ë¦¬ë¡œ ì´ˆê¸° ê²Œì„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
      showRecentGameIcon(); // ìµœê·¼ ë³¸ ê²Œì„ ì•„ì´ì½˜ í‘œì‹œ
    }); // ì¥ë¥´ í•„í„° ë³€ê²½ ì‹œ ê²Œì„ ëª©ë¡ì„ ë‹¤ì‹œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    document.querySelectorAll('input[name="genre"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const categoryId = this.value;
        currentPage = 1; // í˜ì´ì§€ë¥¼ 1ë¡œ ì´ˆê¸°í™”
        fetchGamesByCategory(categoryId);
      });
    });

    // ì •ë ¬ ê¸°ì¤€ ë³€ê²½ ì‹œ ê²Œì„ ëª©ë¡ì„ ë‹¤ì‹œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    document.getElementById('sortOrder').addEventListener('change', function() {
      const sortOrder = this.value;
      const selectedGenre = document.querySelector('input[name="genre"]:checked').value;
      currentPage = 1; // í˜ì´ì§€ë¥¼ 1ë¡œ ì´ˆê¸°í™”
      fetchGamesByCategory(selectedGenre, currentPage, sortOrder);
    });

    // íŒì—…ì„ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
    function showPopup(message) {
      alert(message);
    }

     // ê²Œì„ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
    async function handleGameClick(event, gameId) {
        event.preventDefault(); // ê¸°ë³¸ ë§í¬ ì´ë™ ë™ì‘ ì¤‘ì§€

        try {
            // ìµœê·¼ ë³¸ ê²Œì„ì„ ê¸°ë¡í•˜ëŠ” í•¨ìˆ˜ í˜¸ì¶œ
            await trackRecentGame(gameId);
            // ìµœê·¼ ë³¸ ê²Œì„ ê¸°ë¡ì´ ì™„ë£Œë˜ë©´ ê²Œì„ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
            window.location.href = `gameDetail.html?gameId=${gameId}`;
        } catch (error) {
            console.error('ê²Œì„ í´ë¦­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        }
    }

    // ìµœê·¼ ë³¸ ê²Œì„ì„ ê¸°ë¡í•˜ëŠ” í•¨ìˆ˜
    async function trackRecentGame(gameId) {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.warn('ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            console.log('ìµœê·¼ ë³¸ ê²Œì„ ê¸°ë¡ ì¤‘, gameId:', gameId); // ë¡œê·¸ ì¶”ê°€
            const response = await fetch(`${serverUrl}/api/user/games`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ gameId }),
            });

            if (!response.ok) {
                throw new Error('ìµœê·¼ ë³¸ ê²Œì„ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.');
            }
        } catch (error) {
            console.error('ìµœê·¼ ë³¸ ê²Œì„ì„ ê¸°ë¡í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        }
    }

     // íŒì—…ì°½ì„ ì—´ê³  í† í°ì„ ì „ë‹¬í•˜ëŠ” í•¨ìˆ˜
        function openPopupWithToken() {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                return;
            }
            const popupUrl = `https://gameforge-ai-server.streamlit.app/?token=${token}`;
            const popupWindow = window.open(popupUrl, 'PopupWindow', 'width=600,height=600');
            if (!popupWindow || popupWindow.closed || typeof popupWindow.closed === 'undefined') {
                alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
            }
        }

        // ìµœê·¼ ë³¸ ê²Œì„ í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
        function goToRecentGames() {
            window.location.href = 'recentGames.html';
        }

        // ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.getElementById('open-popup-btn').addEventListener('click', openPopupWithToken);
        document.getElementById('recent-games-btn').addEventListener('click', goToRecentGames);
  </script>
</body>
</html>
