<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main - Game Forge</title>
    <link rel="stylesheet" href="main.css">
</head>
<body>
    <header>
        <h1>환영합니다, <span id="nickname">사용자</span>님!</h1>
        <button id="logout-btn">로그아웃</button>
    </header>
    
    <main>
        <h2>게임 상점</h2>
        <!-- 메인 페이지 콘텐츠 -->
    </main>

    <script>
        const API_BASE_URL = 'https://ludorium.store/api';
        
        // 로컬스토리지에서 토큰을 가져오기
        const accessToken = localStorage.getItem('accessToken');
        const refreshToken = localStorage.getItem('refreshToken');

        // 토큰 디코딩 함수
        function decodeJWT(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        // 메인 페이지 초기화
        function initMainPage() {
            if (!accessToken) {
                alert('로그인이 필요합니다.');
                window.location.href = 'login.html';
                return;
            }

            const decodedToken = decodeJWT(accessToken);
            const nickname = decodedToken.nickname || '사용자';
            document.getElementById('nickname').innerText = nickname;
        }

        // 리프레시 토큰을 이용해 액세스 토큰 갱신
        function refreshAccessToken() {
            fetch(`${API_BASE_URL}/auth/refresh`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${refreshToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.accessToken) {
                    localStorage.setItem('accessToken', data.accessToken);
                    alert('세션이 갱신되었습니다.');
                } else {
                    throw new Error('토큰 갱신 실패');
                }
            })
            .catch(error => {
                console.error('토큰 갱신 오류:', error);
                alert('다시 로그인해주세요.');
                window.location.href = 'login.html';
            });
        }

        // 로그아웃 처리
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            alert('로그아웃되었습니다.');
            window.location.href = 'login.html';
        });

        // 페이지 로딩 시 메인 페이지 초기화
        window.onload = initMainPage;
    </script>
</body>
</html>
