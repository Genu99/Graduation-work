<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Forge - ë§ˆì´í˜ì´ì§€</title>
    <link rel="stylesheet" href="mypage.css">
</head>
<body>
    <!-- í—¤ë” ìë¦¬ í‘œì‹œì -->
    <div id="header-placeholder"></div>

    <!-- í—¤ë” ì•„ë˜ì— ìœ„ì¹˜í•œ ë‚´ë¹„ê²Œì´ì…˜ ë°” -->
    <ul class="menu">
        <li><a href="mypage.html">ë‚´ì •ë³´</a></li>
        <li><a href="info.html">ì •ë³´ìˆ˜ì •</a></li>
        <li><a href="modpwd.html">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</a></li>
        <li><a href="order.html">ì£¼ë¬¸ë‚´ì—­</a></li>
        <li><a href="review.html">ë‚´ê°€ì“´ë¦¬ë·°</a></li>
        <li><a href="deleteId.html">íšŒì›íƒˆí‡´</a></li>
        </ul>
    </nav>

    <main>
        <section class="profile-section">
            <div class="profile-container">
                <div class="profile-header">
                    <label for="profile-image-upload">
                        <img
                            id="profile-image"
                            src="https://via.placeholder.com/100"
                            alt="Profile Icon"
                            class="profile-image"
                        />
                    </label>
                    <input type="file" id="profile-image-upload" style="display: none;" accept="image/*" onchange="uploadImage(event)">
                    <h1 id="user-nickname">ë‹‰ë„¤ì„ ë‹˜ ì•ˆë…•í•˜ì„¸ìš”!</h1>
                </div>

                <div class="profile-info">
                    <div class="profile-row">
                        <span class="label">ì ‘ì† ì¤‘ì¸ ì•„ì´ë””</span>
                        <span class="value" id="user-email">ì´ë©”ì¼ ì •ë³´</span>
                    </div>
                    <div class="profile-row">
                        <span class="label">ì†Œì…œ ë¡œê·¸ì¸</span>
                        <span class="value" id="user-social">ì •ë³´ ì—†ìŒ</span>
                    </div>
                    <div class="profile-row">
                        <span class="label">ìƒë…„ì›”ì¼</span>
                        <span class="value" id="user-birthdate">ìƒë…„ì›”ì¼ ì •ë³´</span>
                    </div>
                    <div class="profile-row">
                        <span class="label">ì „í™”ë²ˆí˜¸</span>
                        <span class="value" id="user-tel">ì „í™”ë²ˆí˜¸ ì •ë³´</span>
                    </div>
                    <div class="profile-row">
                        <span class="label">ì„±ë³„</span>
                        <span class="value" id="user-gender">ì„±ë³„ ì •ë³´ ì—†ìŒ</span>
                    </div>
                    <div class="profile-row">
                        <span class="label">ì ë¦½ê¸ˆ</span>
                        <span class="value" id="user-reward-points">ì ë¦½ê¸ˆ ì •ë³´ ì—†ìŒ</span>
                    </div>
                </div>
            </div>
        </section>
        <!-- ìµœê·¼ ë³¸ ê²Œì„ìœ¼ë¡œ ì´ë™í•˜ëŠ” ë²„íŠ¼ (ë‹ë³´ê¸° ë²„íŠ¼ ìœ„ì— ê³ ì •) -->
        <button id="recent-games-btn" class="circular-btn fixed-btn recent-fixed-btn">ğŸ‘</button>

        <!-- íŒì—…ì„ ì—¬ëŠ” ë²„íŠ¼ (ì˜¤ë¥¸ìª½ ì•„ë˜ ê³ ì •) -->
        <button id="open-popup-btn" class="circular-btn fixed-btn">ğŸ”</button>

    </main>

    <footer>
        <div class="footer-content">
            <p>&copy; ëŒ€ì§„ëŒ€í•™êµ ë²¤ì²˜ ì¡¸ì—…ì‘í’ˆ.</p>
        </div>
    </footer>

    <script src="auth.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // í—¤ë”ë¥¼ ë™ì ìœ¼ë¡œ ë¡œë“œ
            fetch("header.html")
                .then(response => response.text())
                .then(data => {
                    document.getElementById("header-placeholder").innerHTML = data;
                    checkLoginStatus();
                })
                .catch(error => console.error("í—¤ë” ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error));

            // ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸ í›„ ì‚¬ìš©ì ì •ë³´ë¥¼ ì±„ìš°ê¸° ìœ„í•œ í•¨ìˆ˜ í˜¸ì¶œ
            if (!localStorage.getItem('token')) {
                alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”');
                window.location.href = 'login.html';
            } else {
                fetchUserInfo();
            }
        });

        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
       function fetchUserInfo() {
    const apiUrl = 'https://ludorium.store/api/user/mypage';
    fetch(apiUrl, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`ë„¤íŠ¸ì›Œí¬ ì‘ë‹µ ì˜¤ë¥˜: ${response.status} - ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('ì„œë²„ ì‘ë‹µ ë°ì´í„°:', data); // ë°ì´í„°ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ ì „ì²´ ë¡œê·¸ ì¶”ê°€

        // ì‘ë‹µ ë°ì´í„°ì˜ data í•„ë“œ ì ‘ê·¼
        const userData = data.data;

        // ìƒë…„ì›”ì¼ ë°ì´í„°ë¥¼ ë¡œê¹…í•˜ì—¬ í™•ì¸
        console.log('ìƒë…„ì›”ì¼ ë°ì´í„°:', userData.birthdate);

        document.getElementById('user-nickname').textContent = userData.name ? `${userData.name} ë‹˜ ì•ˆë…•í•˜ì„¸ìš”!` : 'ë‹‰ë„¤ì„ ì •ë³´ ì—†ìŒ';
        document.getElementById('user-email').textContent = userData.email || 'ì •ë³´ ì—†ìŒ';
        document.getElementById('user-birthdate').textContent = userData.birthDate ? userData.birthDate.substring(0, 10) : 'ìƒë…„ì›”ì¼ ì •ë³´ ì—†ìŒ';
        document.getElementById('user-tel').textContent = userData.tel || 'ì „í™”ë²ˆí˜¸ ì •ë³´ ì—†ìŒ';
        document.getElementById('user-gender').textContent = userData.gender === 'M' ? 'ë‚¨ì' : userData.gender === 'W' ? 'ì—¬ì' : 'ì„±ë³„ ì •ë³´ ì—†ìŒ';
        document.getElementById('user-reward-points').textContent = userData.rewardPoints !== undefined ? `${userData.rewardPoints} ì›` : 'ì ë¦½ê¸ˆ ì •ë³´ ì—†ìŒ';

        // ì†Œì…œ ë¡œê·¸ì¸ ì •ë³´ í‘œì‹œ
        const provider = userData.provider === 'local' ? 'GameForge' : userData.provider || 'ì •ë³´ ì—†ìŒ';
        document.getElementById('user-social').textContent = provider;

        // í”„ë¡œí•„ ì´ë¯¸ì§€ ì„¤ì •
        if (userData.profileImage) {
            document.getElementById('profile-image').src = userData.profileImage;
        }
    })
    .catch(error => {
        console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        alert(`ì‚¬ìš©ì ì •ë³´ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
    });
}


        // í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ
        function uploadImage(event) {
            const reader = new FileReader();
            reader.onload = function() {
                const profileImage = document.getElementById('profile-image');
                profileImage.src = reader.result;
            };
            reader.readAsDataURL(event.target.files[0]);
        }

        // íŒì—…ì°½ì„ ì—´ê³  í† í°ì„ ì „ë‹¬í•˜ëŠ” í•¨ìˆ˜
function openPopupWithToken() {
    const token = localStorage.getItem('token');
    if (!token) {
        console.error('í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.');
        return;
    }
    const popupUrl = `https://gameforge-ai-server.streamlit.app/?token=${token}`;
    const popupWindow = window.open(popupUrl, 'PopupWindow', 'width=600,height=600');
    if (!popupWindow || popupWindow.closed || typeof popupWindow.closed === 'undefined') {
        alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
    }
}

// ìµœê·¼ ë³¸ ê²Œì„ í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
function goToRecentGames() {
    window.location.href = 'recentGames.html';
}

// ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
document.getElementById('open-popup-btn').addEventListener('click', openPopupWithToken);
document.getElementById('recent-games-btn').addEventListener('click', goToRecentGames);

    </script>
</body>
</html>
